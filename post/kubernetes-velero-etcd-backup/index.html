<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage data-theme=light><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>制定kubernetes集群备份策略 - 丸子有记
</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=color-scheme content="light dark"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=author content="wanzi"><meta name=description content="制定kubernetes集群备份策略"><meta name=keywords content="丸子有记,运维,devops,sre,运维架构,运维开发,go语言,python"><meta name=generator content="Hugo 0.121.0"><link rel=canonical href=/post/kubernetes-velero-etcd-backup/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/css/style.min.4d9e22c6c4a4cfe9ca1e35f9578ca6c8ff84c408a5f0599c8cbdaf444e95eae8.css integrity="sha256-TZ4ixsSkz+nKHjX5V4ymyP+ExAil8FmcjL2vRE6V6ug=" media=screen crossorigin=anonymous><meta property="og:title" content="制定kubernetes集群备份策略"><meta property="og:description" content="制定kubernetes集群备份策略"><meta property="og:type" content="article"><meta property="og:url" content="/post/kubernetes-velero-etcd-backup/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-09-11T17:22:42+08:00"><meta property="article:modified_time" content="2021-09-11T17:22:42+08:00"><meta itemprop=name content="制定kubernetes集群备份策略"><meta itemprop=description content="制定kubernetes集群备份策略"><meta itemprop=datePublished content="2021-09-11T17:22:42+08:00"><meta itemprop=dateModified content="2021-09-11T17:22:42+08:00"><meta itemprop=wordCount content="3007"><meta itemprop=keywords content="velero,k8s,备份,keepalived,"><meta name=twitter:card content="summary"><meta name=twitter:title content="制定kubernetes集群备份策略"><meta name=twitter:description content="制定kubernetes集群备份策略"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--><script>(function(){var e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e)})()</script></head><body><div id=back-to-top></div><header><div class=desktop-header><div class=desktop-header-logo><a href=/ class=logo>丸子有记</a></div><nav class=desktop-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/post/>归档</a></li><li class=menu-item><a class=menu-item-link href=/tags/>标签</a></li><li class=menu-item><a class=menu-item-link href=/categories/>分类</a></li><li class=menu-item><a class=menu-item-link href=/>external-link</a></li><li class=menu-item><a class=menu-item-link href=/notes/>笔记</a></li><li class=menu-item><a class=menu-item-link href=/about/>关于</a></li><li class=menu-item><a class="menu-item-link menu-parent menu-item-lang" href=#></a><ul class=submenu><li class=submenu-item><a href=/zh-cn/></a></li></ul></li><li class=menu-item><a id=openSearch class="menu-item-link menu-item-search" href=#></a></li><li class=menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);></a></li><li class=menu-item><a class=menu-item-link href=/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank></a></li></ul></nav></div><div class=mobile-header><div id=mobile-navbar class=mobile-navbar><div id=mobile-navbar-icon class=mobile-navbar-icon></div><div class=mobile-navbar-logo><a href=/%20/ class=logo>丸子有记</a></div></div><div id=mobile-menu-close-modal class=mobile-menu-close-modal></div><nav id=mobile-menu class=mobile-menu><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=/post/>归档</a></li><li class=mobile-menu-item><a class=menu-item-link href=/tags/>标签</a></li><li class=mobile-menu-item><a class=menu-item-link href=/categories/>分类</a></li><li class=mobile-menu-item><a class=menu-item-link href=/>external-link</a></li><li class=mobile-menu-item><a class=menu-item-link href=/notes/>笔记</a></li><li class=mobile-menu-item><a class=menu-item-link href=/about/>关于</a></li><li class=mobile-menu-item><div class="mobile-menu-parent mobile-menu-item-lang"><span class=mobile-submenu-open></span>
<a href=#>Language</a></div><ul class=mobile-submenu-list><li><a href=/><strong></strong></a></li><li><a href=/zh-cn/></a></li></ul></li><li class=mobile-menu-item><a id=openSearchMobile class="mobile-menu-item-link menu-item-search" href=#></a></li><li class=mobile-menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);></a></li><li class=mobile-menu-item><a class=menu-item-link href=/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank></a></li></ul></nav></div></header><main id=main class="main pico container"><div class=content-wrapper><aside class=sidebar></aside><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>制定kubernetes集群备份策略</h1><div class=post-meta-list><div class="post-meta-item post-meta-author"><a href=/about><span class=post-meta-author-name>wanzi</span></a></div><div class="post-meta-item post-meta-time"><time datetime=2021-09-11>2021-09-11</time></div><div class=post-meta__right><span class=post-meta-more>3007 words -
7 min read
- <span class=remark42__counter data-url=/post/kubernetes-velero-etcd-backup/></span> Comments</span><div class="post-meta-item post-meta-category"><a href=/categories/kubernetes/>kubernetes</a></div><span id=busuanzi_container_page_pv>| 阅读 <span id=busuanzi_value_page_pv></span></span></div></div></header><div class=post-content><p>对于备份，每家互联网公司技术人员都要去做的一件事儿，当然我们也不例外，今天我主要针对生产环境kubernetes集群制定一些自己的策略，这里分享给大家。</p><p>我这里kubernetes备份目的主要为了防止如下情况出现：</p><ul><li>防止误操作删除集群中某一个namespace</li><li>防止误操作导致集群中某一个资源出现异常，比如deployment、configmap等</li><li>防止误操作删除集群部分资源对象</li><li>防止etcd数据丢失</li></ul><h2 id=备份etcd>备份ETCD</h2><p>备份etcd，防止k8s集群出现了集群级别故障或etcd数据丢失情况，导致整个集群不可用的情况，这种情况只能通过恢复集群恢复业务。</p><p>备份etcd脚本如下：</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-10>10</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#007020>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#007020></span><span style=color:#60a0b0;font-style:italic>#ENDPOINTS=&#34;https://192.168.1.207:2379,https://192.168.1.208:2379,https://192.168.1.209:2379&#34;</span>
</span></span><span style=display:flex><span><span style=color:#bb60d5>ENDPOINTS</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;127.0.0.1:2379&#34;</span>
</span></span><span style=display:flex><span><span style=color:#bb60d5>CACERT</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;/etc/kubernetes/pki/etcd/ca.crt&#34;</span>
</span></span><span style=display:flex><span><span style=color:#bb60d5>CERT</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;/etc/kubernetes/pki/etcd/server.crt&#34;</span>
</span></span><span style=display:flex><span><span style=color:#bb60d5>KEY</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;/etc/kubernetes/pki/etcd/server.key&#34;</span>
</span></span><span style=display:flex><span><span style=color:#bb60d5>DATE</span><span style=color:#666>=</span><span style=color:#4070a0>`</span>date +%Y%m%d-%H%M%S<span style=color:#4070a0>`</span>
</span></span><span style=display:flex><span><span style=color:#bb60d5>BACKUP_DIR</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;/home/centos/hostpath/backups/k8s/etcd&#34;</span>
</span></span><span style=display:flex><span><span style=color:#bb60d5>ETCDCTL_API</span><span style=color:#666>=</span><span style=color:#40a070>3</span> /usr/local/bin/etcdctl --cacert<span style=color:#666>=</span><span style=color:#70a0d0>${</span><span style=color:#bb60d5>CACERT</span><span style=color:#70a0d0>}</span> --cert<span style=color:#666>=</span><span style=color:#70a0d0>${</span><span style=color:#bb60d5>CERT</span><span style=color:#70a0d0>}</span> --key<span style=color:#666>=</span><span style=color:#70a0d0>${</span><span style=color:#bb60d5>KEY</span><span style=color:#70a0d0>}</span>  --endpoints<span style=color:#666>=</span><span style=color:#4070a0>&#34;</span><span style=color:#70a0d0>${</span><span style=color:#bb60d5>ENDPOINTS</span><span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span> snapshot save <span style=color:#70a0d0>${</span><span style=color:#bb60d5>BACKUP_DIR</span><span style=color:#70a0d0>}</span>/k8s-snapshot-<span style=color:#70a0d0>${</span><span style=color:#bb60d5>DATE</span><span style=color:#70a0d0>}</span>.db
</span></span><span style=display:flex><span>find  <span style=color:#bb60d5>$BACKUP_DIR</span>/ -type f -mtime +20 -exec rm -f <span style=color:#666>{}</span> <span style=color:#4070a0;font-weight:700>\;</span></span></span></code></pre></td></tr></table></div></div></div><p>cron任务计划：</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#40a070>50</span><span style=color:#bbb> </span><span style=color:#40a070>21</span><span style=color:#bbb> </span>*<span style=color:#bbb> </span>*<span style=color:#bbb> </span>*<span style=color:#bbb> </span>/bin/bash /home/centos/hostpath/backups/k8s/etcdv3-bak.sh</span></span></code></pre></td></tr></table></div></div></div><h2 id=minio对象存储服务搭建>minio对象存储服务搭建</h2><p>由于我们的存储集群采用的GlusterFS搭建，因此，这里我只能使用minio搭建对象存储，底层采用GlusterFS文件系统；如果你使用阿里云OSS备份你集群资源，请忽略这一步，可以移驾：https://github.com/AliyunContainerService/velero-plugin</p><p>由于minio在k8s环境下搭建需要提供对应存储pv/pvc，这里为了简单，直接启动docker方式：</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-29>29</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#062873;font-weight:700>version</span>:<span style=color:#bbb> </span><span style=color:#4070a0>&#39;2.0&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#062873;font-weight:700>services</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#062873;font-weight:700>minio</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#062873;font-weight:700>image</span>:<span style=color:#bbb> </span>minio/minio:latest<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#062873;font-weight:700>container_name</span>:<span style=color:#bbb> </span>minio<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#062873;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#4070a0>&#34;39000:9000&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#4070a0>&#34;39001:9001&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#062873;font-weight:700>restart</span>:<span style=color:#bbb> </span>always<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#062873;font-weight:700>command</span>:<span style=color:#bbb> </span>server --console-address &#39;:9001&#39; /data<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#062873;font-weight:700>environment</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#062873;font-weight:700>MINIO_ACCESS_KEY</span>:<span style=color:#bbb> </span>admin<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#062873;font-weight:700>MINIO_SECRET_KEY</span>:<span style=color:#bbb> </span>adminSD#123<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#062873;font-weight:700>logging</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#062873;font-weight:700>options</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#062873;font-weight:700>max-size</span>:<span style=color:#bbb> </span><span style=color:#4070a0>&#34;1000M&#34;</span><span style=color:#bbb> </span><span style=color:#60a0b0;font-style:italic># 最大文件上传限制</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#062873;font-weight:700>max-file</span>:<span style=color:#bbb> </span><span style=color:#4070a0>&#34;100&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#062873;font-weight:700>driver</span>:<span style=color:#bbb> </span>json-file<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#062873;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- /home/centos/hostpath/backups/k8s/velero:/data<span style=color:#bbb> </span><span style=color:#60a0b0;font-style:italic># 映射文件路径</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#062873;font-weight:700>networks</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- minio<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#062873;font-weight:700>networks</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#062873;font-weight:700>minio</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#062873;font-weight:700>ipam</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#062873;font-weight:700>config</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#062873;font-weight:700>subnet</span>:<span style=color:#bbb> </span><span style=color:#40a070>10.210.1.0</span>/24<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#062873;font-weight:700>gateway</span>:<span style=color:#bbb> </span><span style=color:#40a070>10.210.1.1</span></span></span></code></pre></td></tr></table></div></div></div><p>打开浏览器输入如下地址和账户信息，就可以通过web控制台管理minio对象存储了</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-3>3</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>minio web：http://192.168.1.214:39001
</span></span><span style=display:flex><span>minio admin：admin
</span></span><span style=display:flex><span>minio admin passwd：adminSD#123</span></span></code></pre></td></tr></table></div></div></div><h2 id=velero备份之安装客户端>velero备份之安装客户端</h2><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>brew install velero</span></span></code></pre></td></tr></table></div></div></div><p>创建文件credentials-velero内容如下,方便后边创建velero server端连接对象存储使用：</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3>3</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>[default]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>aws_access_key_id = admin<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>aws_secret_access_key = adminSD#123</span></span></code></pre></td></tr></table></div></div></div><h2 id=velero备份之k8s部署velero>velero备份之k8s部署velero</h2><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-6>6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-7>7</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># velero install \</span>
</span></span><span style=display:flex><span>    --provider aws <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>    --plugins velero/velero-plugin-for-aws:v1.2.0 <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>    --bucket k8s-jf <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>    --secret-file ./credentials-velero <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>    --use-volume-snapshots<span style=color:#666>=</span><span style=color:#007020>false</span> <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>    --backup-location-config <span style=color:#bb60d5>region</span><span style=color:#666>=</span>minio,s3ForcePathStyle<span style=color:#666>=</span><span style=color:#4070a0>&#34;true&#34;</span>,s3Url<span style=color:#666>=</span>http://192.168.1.214:39000</span></span></code></pre></td></tr></table></div></div></div><h2 id=velero备份之velero命令>velero备份之velero命令</h2><h3 id=备份查看删除操作>备份,查看,删除操作</h3><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-21>21</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#备份集群ingress-nginx namespace下资源:</span>
</span></span><span style=display:flex><span>velero backup create ingress-nginx-backup --include-namespaces ingress-nginx
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#查看备份结果</span>
</span></span><span style=display:flex><span>velero backup describe ingress-nginx-backup
</span></span><span style=display:flex><span>velero backup logs ingress-nginx-backup
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#删除备份</span>
</span></span><span style=display:flex><span>velero delete backup ingress-nginx-backup
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#备份非ingress-nginx和test命名空间下的资源：</span>
</span></span><span style=display:flex><span>velero backup create k8s-full-test-backup --exclude-namespaces ingress-nginx,test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#备份特定资源类型</span>
</span></span><span style=display:flex><span>velero backup create kube-system-backup --include-resources pod,secret
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#--confirm 直接删除备份，无需确认：</span>
</span></span><span style=display:flex><span>velero backup delete kube-system-backup --confirm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#备份带pv pod</span>
</span></span><span style=display:flex><span>velero backup create pvc-backup  --snapshot-volumes --include-namespaces test-velero</span></span></code></pre></td></tr></table></div></div></div><p>注意：</p><ul><li>&ndash;include-resources备份指定资源类型, &ndash;exclude-resources指定排除某些资源类型</li></ul><h3 id=定时备份>定时备份：</h3><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-11>11</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># 每六个小时备份一次</span>
</span></span><span style=display:flex><span>velero create schedule <span style=color:#70a0d0>${</span><span style=color:#bb60d5>SCHEDULE_NAME</span><span style=color:#70a0d0>}</span> --schedule<span style=color:#666>=</span><span style=color:#4070a0>&#34;0 */6 * * *&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># 每六个小时使用every备份一次</span>
</span></span><span style=display:flex><span>velero create schedule <span style=color:#70a0d0>${</span><span style=color:#bb60d5>SCHEDULE_NAME</span><span style=color:#70a0d0>}</span> --schedule<span style=color:#666>=</span><span style=color:#4070a0>&#34;@every 6h&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># 创建一个web命名空间的天备份</span>
</span></span><span style=display:flex><span>velero create schedule <span style=color:#70a0d0>${</span><span style=color:#bb60d5>SCHEDULE_NAME</span><span style=color:#70a0d0>}</span> --schedule<span style=color:#666>=</span><span style=color:#4070a0>&#34;@every 24h&#34;</span> --include-namespaces web
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># 创建一个周备份，持续时间为90天。</span>
</span></span><span style=display:flex><span>velero create schedule <span style=color:#70a0d0>${</span><span style=color:#bb60d5>SCHEDULE_NAME</span><span style=color:#70a0d0>}</span> --schedule<span style=color:#666>=</span><span style=color:#4070a0>&#34;@every 168h&#34;</span> --ttl 2160h0m0s</span></span></code></pre></td></tr></table></div></div></div><p>说明：&ndash;ttl可以指定backup的生存周期，在ttl超时后，backup会被定期清理,ttl默认30天</p><h3 id=备份恢复>备份恢复：</h3><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-20>20</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#从backup创建restore</span>
</span></span><span style=display:flex><span>velero restore create <span style=color:#70a0d0>${</span><span style=color:#bb60d5>RESTORE_NAME</span><span style=color:#70a0d0>}</span> --from-backup <span style=color:#70a0d0>${</span><span style=color:#bb60d5>BACKUP_NAME</span><span style=color:#70a0d0>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># 从backup创建restore，restore默认名为 ${BACKUP_NAME}-&lt;timestamp&gt;</span>
</span></span><span style=display:flex><span>velero restore create --from-backup <span style=color:#70a0d0>${</span><span style=color:#bb60d5>BACKUP_NAME</span><span style=color:#70a0d0>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># 从schedule最新一次的backup创建restore</span>
</span></span><span style=display:flex><span>velero restore create --from-schedule <span style=color:#70a0d0>${</span><span style=color:#bb60d5>SCHEDULE_NAME</span><span style=color:#70a0d0>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># 指定backup中的某些资源创建restore</span>
</span></span><span style=display:flex><span>velero restore create --from-backup backup-2 --include-resources pod,secret
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># 恢复集群所有备份，（对已经存在的服务不会覆盖）</span>
</span></span><span style=display:flex><span>velero restore create --from-backup all-ns-backup
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># 仅恢复default nginx-example命名空间</span>
</span></span><span style=display:flex><span>velero restore create --from-backup all-ns-backup --include-namespaces default,nginx-example 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># 将test-velero 命名空间资源恢复到test-velero-1下面</span>
</span></span><span style=display:flex><span>velero restore create restore-for-test --from-backup everyday-1-20210203131802 --namespace-mappings test-velero:test-velero-1</span></span></code></pre></td></tr></table></div></div></div><p>查看备份</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-4>4</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>velero  get  backup   <span style=color:#60a0b0;font-style:italic>#备份查看</span>
</span></span><span style=display:flex><span>velero  get  schedule <span style=color:#60a0b0;font-style:italic>#查看定时备份</span>
</span></span><span style=display:flex><span>velero  get  restore  <span style=color:#60a0b0;font-style:italic>#查看已有的恢复</span>
</span></span><span style=display:flex><span>velero  get  plugins  <span style=color:#60a0b0;font-style:italic>#查看插件</span></span></span></code></pre></td></tr></table></div></div></div><p>说明：</p><p>velero restore create RESTORE_NAME &ndash;from-backup BACKUP_NAME &ndash;namespace-mappings old-ns-1:new-ns-1,old-ns-2:new-ns-2</p><p>Velero可以将资源还原到与其备份来源不同的命名空间中。为此，请使用&ndash;namespace-mappings标志</p><h2 id=velero备份实战>velero备份实战</h2><h3 id=velero对集群进行一次完整备份>velero对集群进行一次完整备份：</h3><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>velero backup create  k8s-jf-test-all</span></span></code></pre></td></tr></table></div></div></div><h3 id=设置4小时定时备份一次备份保留2个月>设置4小时定时备份一次，备份保留2个月：</h3><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-2>2</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># velero create schedule k8s-jf-cron-4h --exclude-namespaces test,tt --schedule=&#34;@every 4h&#34; --ttl 1440h</span>
</span></span><span style=display:flex><span>Schedule <span style=color:#4070a0>&#34;k8s-jf-cron-4h&#34;</span> created successfully.</span></span></code></pre></td></tr></table></div></div></div><h3 id=同集群下手动从完整备份中恢复其中一个namespace到指定namespace>同集群下，手动从完整备份中恢复其中一个namespace到指定namespace</h3><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-26>26</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># velero restore create  k8s-jf-test-all-restore --from-backup  k8s-jf-test-all --include-namespaces test --namespace-mappings  test:test10000</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># velero restore describe k8s-jf-test-all-restore #查看恢复状态</span>
</span></span><span style=display:flex><span>Name:         k8s-jf-test-all-restore
</span></span><span style=display:flex><span>Namespace:    velero
</span></span><span style=display:flex><span>Labels:       &lt;none&gt;
</span></span><span style=display:flex><span>Annotations:  &lt;none&gt;
</span></span><span style=display:flex><span>Phase:                                 InProgress
</span></span><span style=display:flex><span>Estimated total items to be restored:  <span style=color:#40a070>141</span>
</span></span><span style=display:flex><span>Items restored so far:                 <span style=color:#40a070>123</span>
</span></span><span style=display:flex><span>Started:    2021-09-07 10:47:44 +0800 CST
</span></span><span style=display:flex><span>Completed:  &lt;n/a&gt;
</span></span><span style=display:flex><span>Backup:  k8s-jf-test-all
</span></span><span style=display:flex><span>Namespaces:
</span></span><span style=display:flex><span>  Included:  all namespaces found in the backup
</span></span><span style=display:flex><span>  Excluded:  &lt;none&gt;
</span></span><span style=display:flex><span>Resources:
</span></span><span style=display:flex><span>  Included:        *
</span></span><span style=display:flex><span>  Excluded:        nodes, events, events.events.k8s.io, backups.velero.io, restores.velero.io, resticrepositories.velero.io
</span></span><span style=display:flex><span>  Cluster-scoped:  auto
</span></span><span style=display:flex><span>Namespace mappings:  <span style=color:#bb60d5>test</span><span style=color:#666>=</span>test10000
</span></span><span style=display:flex><span>Label selector:  &lt;none&gt;
</span></span><span style=display:flex><span>Restore PVs:  auto
</span></span><span style=display:flex><span>Preserve Service NodePorts:  auto
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># velero restore get</span>
</span></span><span style=display:flex><span>NAME                      BACKUP            STATUS       STARTED                         COMPLETED   ERRORS   WARNINGS   CREATED                         SELECTOR
</span></span><span style=display:flex><span>k8s-jf-test-all-restore   k8s-jf-test-all   InProgress   2021-09-07 10:47:44 +0800 CST   &lt;nil&gt;       <span style=color:#40a070>0</span>        <span style=color:#40a070>0</span>          2021-09-07 10:47:44 +0800 CST   &lt;none&gt;</span></span></code></pre></td></tr></table></div></div></div><h3 id=跨集群将定期备份数据恢复>跨集群，将定期备份数据恢复</h3><p>对于velero，跨集群需要保持2个集群使用的是同一个云厂商持久卷方案，这里我们统一使用minio，bucket都使用k8s-jf</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-6>6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-7>7</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>velero install <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>    --provider aws <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>    --plugins velero/velero-plugin-for-aws:v1.2.0 <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>    --bucket k8s-jf <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>    --secret-file ./credentials-velero <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>    --use-volume-snapshots<span style=color:#666>=</span><span style=color:#007020>false</span> <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>    --backup-location-config <span style=color:#bb60d5>region</span><span style=color:#666>=</span>minio,s3ForcePathStyle<span style=color:#666>=</span><span style=color:#4070a0>&#34;true&#34;</span>,s3Url<span style=color:#666>=</span>http://192.168.1.214:39000</span></span></code></pre></td></tr></table></div></div></div><h3 id=查看已经备份数据>查看已经备份数据：</h3><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-5>5</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#velero backup get</span>
</span></span><span style=display:flex><span>NAME                                STATUS            ERRORS   WARNINGS   CREATED                         EXPIRES   STORAGE LOCATION   SELECTOR
</span></span><span style=display:flex><span>k8s-jf-all-cron-4h-20210907061716   Completed         <span style=color:#40a070>0</span>        <span style=color:#40a070>0</span>          2021-09-07 14:17:16 +0800 CST   59d       default            &lt;none&gt;
</span></span><span style=display:flex><span>k8s-jf-all-cron-4h-20210907021627   Completed         <span style=color:#40a070>0</span>        <span style=color:#40a070>0</span>          2021-09-07 10:16:27 +0800 CST   59d       default            &lt;none&gt;
</span></span><span style=display:flex><span>k8s-jf-test-all                     Completed         <span style=color:#40a070>0</span>        <span style=color:#40a070>0</span>          2021-09-07 10:19:45 +0800 CST   29d       default            &lt;none&gt;</span></span></code></pre></td></tr></table></div></div></div><h3 id=恢复指定命名空间数据>恢复指定命名空间数据</h3><p>这里从k8s-jf-all-cron-4h-20210907061716这个备份恢复argocd命名空间数据到本集群argocd-dev下</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-25>25</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># velero restore create  --from-backup  k8s-jf-all-cron-4h-20210907061716 --include-namespaces argocd --namespace-mappings  argocd:argocd-dev</span>
</span></span><span style=display:flex><span>Restore request <span style=color:#4070a0>&#34;k8s-jf-all-cron-4h-20210907061716-20210907155450&#34;</span> submitted successfully.
</span></span><span style=display:flex><span>Run <span style=color:#4070a0>`</span>velero restore describe k8s-jf-all-cron-4h-20210907061716-20210907155450<span style=color:#4070a0>`</span> or <span style=color:#4070a0>`</span>velero restore logs k8s-jf-all-cron-4h-20210907061716-20210907155450<span style=color:#4070a0>`</span> <span style=color:#007020;font-weight:700>for</span> more details.
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># velero restore get</span>
</span></span><span style=display:flex><span>NAME                                               BACKUP                              STATUS       STARTED                         COMPLETED   ERRORS   WARNINGS   CREATED                         SELECTOR
</span></span><span style=display:flex><span>k8s-jf-all-cron-4h-20210907061716-20210907155450   k8s-jf-all-cron-4h-20210907061716   InProgress   2021-09-07 15:54:51 +0800 CST   &lt;nil&gt;       <span style=color:#40a070>0</span>        <span style=color:#40a070>0</span>          2021-09-07 15:54:51 +0800 CST   &lt;none&gt;
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># velero restore logs k8s-jf-all-cron-4h-20210907061716-20210907161119</span>
</span></span><span style=display:flex><span><span style=color:#bb60d5>time</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;2021-09-07T08:11:23Z&#34;</span> <span style=color:#bb60d5>level</span><span style=color:#666>=</span>info <span style=color:#bb60d5>msg</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;Attempting to restore Secret: argocd-application-controller-token-wv62v&#34;</span> <span style=color:#bb60d5>logSource</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;pkg/restore/restore.go:1238&#34;</span> <span style=color:#bb60d5>restore</span><span style=color:#666>=</span>velero/k8s-jf-all-cron-4h-20210907061716-20210907161119
</span></span><span style=display:flex><span><span style=color:#bb60d5>time</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;2021-09-07T08:11:23Z&#34;</span> <span style=color:#bb60d5>level</span><span style=color:#666>=</span>info <span style=color:#bb60d5>msg</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;Restored 2 items out of an estimated total of 61 (estimate will change throughout the restore)&#34;</span> <span style=color:#bb60d5>logSource</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;pkg/restore/restore.go:664&#34;</span> <span style=color:#bb60d5>name</span><span style=color:#666>=</span>argocd-application-controller-token-wv62v <span style=color:#bb60d5>namespace</span><span style=color:#666>=</span>argocd-dev <span style=color:#bb60d5>progress</span><span style=color:#666>=</span> <span style=color:#bb60d5>resource</span><span style=color:#666>=</span>secrets <span style=color:#bb60d5>restore</span><span style=color:#666>=</span>velero/k8s-jf-all-cron-4h-20210907061716-20210907161119
</span></span><span style=display:flex><span><span style=color:#bb60d5>time</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;2021-09-07T08:11:23Z&#34;</span> <span style=color:#bb60d5>level</span><span style=color:#666>=</span>info <span style=color:#bb60d5>msg</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;Attempting to restore Secret: argocd-dex-server-token-9n4rs&#34;</span> <span style=color:#bb60d5>logSource</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;pkg/restore/restore.go:1238&#34;</span> <span style=color:#bb60d5>restore</span><span style=color:#666>=</span>velero/k8s-jf-all-cron-4h-20210907061716-20210907161119
</span></span><span style=display:flex><span><span style=color:#bb60d5>time</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;2021-09-07T08:11:23Z&#34;</span> <span style=color:#bb60d5>level</span><span style=color:#666>=</span>info <span style=color:#bb60d5>msg</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;Restored 3 items out of an estimated total of 61 (estimate will change throughout the restore)&#34;</span> <span style=color:#bb60d5>logSource</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;pkg/restore/restore.go:664&#34;</span> <span style=color:#bb60d5>name</span><span style=color:#666>=</span>argocd-dex-server-token-9n4rs <span style=color:#bb60d5>namespace</span><span style=color:#666>=</span>argocd-dev <span style=color:#bb60d5>progress</span><span style=color:#666>=</span> <span style=color:#bb60d5>resource</span><span style=color:#666>=</span>secrets <span style=color:#bb60d5>restore</span><span style=color:#666>=</span>velero/k8s-jf-all-cron-4h-20210907061716-20210907161119
</span></span><span style=display:flex><span><span style=color:#bb60d5>time</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;2021-09-07T08:11:23Z&#34;</span> <span style=color:#bb60d5>level</span><span style=color:#666>=</span>info <span style=color:#bb60d5>msg</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;Attempting to restore Secret: argocd-secret&#34;</span> <span style=color:#bb60d5>logSource</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;pkg/restore/restore.go:1238&#34;</span> <span style=color:#bb60d5>restore</span><span style=color:#666>=</span>velero/k8s-jf-all-cron-4h-20210907061716-20210907161119
</span></span><span style=display:flex><span><span style=color:#bb60d5>time</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;2021-09-07T08:11:23Z&#34;</span> <span style=color:#bb60d5>level</span><span style=color:#666>=</span>info <span style=color:#bb60d5>msg</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;Restored 4 items out of an estimated total of 61 (estimate will change throughout the restore)&#34;</span> <span style=color:#bb60d5>logSource</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;pkg/restore/restore.go:664&#34;</span> <span style=color:#bb60d5>name</span><span style=color:#666>=</span>argocd-secret <span style=color:#bb60d5>namespace</span><span style=color:#666>=</span>argocd-dev <span style=color:#bb60d5>progress</span><span style=color:#666>=</span> <span style=color:#bb60d5>resource</span><span style=color:#666>=</span>secrets <span style=color:#bb60d5>restore</span><span style=color:#666>=</span>velero/k8s-jf-all-cron-4h-20210907061716-20210907161119
</span></span><span style=display:flex><span><span style=color:#bb60d5>time</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;2021-09-07T08:11:23Z&#34;</span> <span style=color:#bb60d5>level</span><span style=color:#666>=</span>info <span style=color:#bb60d5>msg</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;Attempting to restore Secret: argocd-server-token-48vjd&#34;</span> <span style=color:#bb60d5>logSource</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;pkg/restore/restore.go:1238&#34;</span> <span style=color:#bb60d5>restore</span><span style=color:#666>=</span>velero/k8s-jf-all-cron-4h-20210907061716-20210907161119
</span></span><span style=display:flex><span><span style=color:#bb60d5>time</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;2021-09-07T08:11:23Z&#34;</span> <span style=color:#bb60d5>level</span><span style=color:#666>=</span>info <span style=color:#bb60d5>msg</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;Restored 5 items out of an estimated total of 61 (estimate will change throughout the restore)&#34;</span> <span style=color:#bb60d5>logSource</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;pkg/restore/restore.go:664&#34;</span> <span style=color:#bb60d5>name</span><span style=color:#666>=</span>argocd-server-token-48vjd <span style=color:#bb60d5>namespace</span><span style=color:#666>=</span>argocd-dev <span style=color:#bb60d5>progress</span><span style=color:#666>=</span> <span style=color:#bb60d5>resource</span><span style=color:#666>=</span>secrets <span style=color:#bb60d5>restore</span><span style=color:#666>=</span>velero/k8s-jf-all-cron-4h-20210907061716-20210907161119
</span></span><span style=display:flex><span><span style=color:#bb60d5>time</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;2021-09-07T08:11:23Z&#34;</span> <span style=color:#bb60d5>level</span><span style=color:#666>=</span>info <span style=color:#bb60d5>msg</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;Attempting to restore Secret: cluster-192.168.1.210-3497337724&#34;</span> <span style=color:#bb60d5>logSource</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;pkg/restore/restore.go:1238&#34;</span> <span style=color:#bb60d5>restore</span><span style=color:#666>=</span>velero/k8s-jf-all-cron-4h-20210907061716-20210907161119
</span></span><span style=display:flex><span><span style=color:#bb60d5>time</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;2021-09-07T08:11:23Z&#34;</span> <span style=color:#bb60d5>level</span><span style=color:#666>=</span>info <span style=color:#bb60d5>msg</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;Restored 6 items out of an estimated total of 61 (estimate will change throughout the restore)&#34;</span> <span style=color:#bb60d5>logSource</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;pkg/restore/restore.go:664&#34;</span> <span style=color:#bb60d5>name</span><span style=color:#666>=</span>cluster-192.168.1.210-3497337724 <span style=color:#bb60d5>namespace</span><span style=color:#666>=</span>argocd-dev <span style=color:#bb60d5>progress</span><span style=color:#666>=</span> <span style=color:#bb60d5>resource</span><span style=color:#666>=</span>secrets <span style=color:#bb60d5>restore</span><span style=color:#666>=</span>velero/k8s-jf-all-cron-4h-20210907061716-20210907161119
</span></span><span style=display:flex><span><span style=color:#bb60d5>time</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;2021-09-07T08:11:23Z&#34;</span> <span style=color:#bb60d5>level</span><span style=color:#666>=</span>info <span style=color:#bb60d5>msg</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;Attempting to restore Secret: cluster-192.168.1.214-1096681010&#34;</span> <span style=color:#bb60d5>logSource</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;pkg/restore/restore.go:1238&#34;</span> <span style=color:#bb60d5>restore</span><span style=color:#666>=</span>velero/k8s-jf-all-cron-4h-20210907061716-20210907161119
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#bb60d5>time</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;2021-09-07T08:11:30Z&#34;</span> <span style=color:#bb60d5>level</span><span style=color:#666>=</span>info <span style=color:#bb60d5>msg</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;Restored 61 items out of an estimated total of 61 (estimate will change throughout the restore)&#34;</span> <span style=color:#bb60d5>logSource</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;pkg/restore/restore.go:664&#34;</span> <span style=color:#bb60d5>name</span><span style=color:#666>=</span>argocd-server <span style=color:#bb60d5>namespace</span><span style=color:#666>=</span>argocd-dev <span style=color:#bb60d5>progress</span><span style=color:#666>=</span> <span style=color:#bb60d5>resource</span><span style=color:#666>=</span>services <span style=color:#bb60d5>restore</span><span style=color:#666>=</span>velero/k8s-jf-all-cron-4h-20210907061716-20210907161119
</span></span><span style=display:flex><span><span style=color:#bb60d5>time</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;2021-09-07T08:11:30Z&#34;</span> <span style=color:#bb60d5>level</span><span style=color:#666>=</span>info <span style=color:#bb60d5>msg</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;Waiting for all restic restores to complete&#34;</span> <span style=color:#bb60d5>logSource</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;pkg/restore/restore.go:546&#34;</span> <span style=color:#bb60d5>restore</span><span style=color:#666>=</span>velero/k8s-jf-all-cron-4h-20210907061716-20210907161119
</span></span><span style=display:flex><span><span style=color:#bb60d5>time</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;2021-09-07T08:11:30Z&#34;</span> <span style=color:#bb60d5>level</span><span style=color:#666>=</span>info <span style=color:#bb60d5>msg</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;Done waiting for all restic restores to complete&#34;</span> <span style=color:#bb60d5>logSource</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;pkg/restore/restore.go:562&#34;</span> <span style=color:#bb60d5>restore</span><span style=color:#666>=</span>velero/k8s-jf-all-cron-4h-20210907061716-20210907161119
</span></span><span style=display:flex><span><span style=color:#bb60d5>time</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;2021-09-07T08:11:30Z&#34;</span> <span style=color:#bb60d5>level</span><span style=color:#666>=</span>info <span style=color:#bb60d5>msg</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;Waiting for all post-restore-exec hooks to complete&#34;</span> <span style=color:#bb60d5>logSource</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;pkg/restore/restore.go:566&#34;</span> <span style=color:#bb60d5>restore</span><span style=color:#666>=</span>velero/k8s-jf-all-cron-4h-20210907061716-20210907161119
</span></span><span style=display:flex><span><span style=color:#bb60d5>time</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;2021-09-07T08:11:30Z&#34;</span> <span style=color:#bb60d5>level</span><span style=color:#666>=</span>info <span style=color:#bb60d5>msg</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;Done waiting for all post-restore exec hooks to complete&#34;</span> <span style=color:#bb60d5>logSource</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;pkg/restore/restore.go:574&#34;</span> <span style=color:#bb60d5>restore</span><span style=color:#666>=</span>velero/k8s-jf-all-cron-4h-20210907061716-20210907161119
</span></span><span style=display:flex><span><span style=color:#bb60d5>time</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;2021-09-07T08:11:30Z&#34;</span> <span style=color:#bb60d5>level</span><span style=color:#666>=</span>info <span style=color:#bb60d5>msg</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;restore completed&#34;</span> <span style=color:#bb60d5>logSource</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;pkg/controller/restore_controller.go:480&#34;</span> <span style=color:#bb60d5>restore</span><span style=color:#666>=</span>velero/k8s-jf-all-cron-4h-20210907061716-20210907161119</span></span></code></pre></td></tr></table></div></div></div><p>通过日志可以看到原集群argo下数据已经恢复到现在集群argo-dev下</p><h3 id=卸载velero>卸载velero</h3><p>卸载velero，注意这里的uninstall不会删除namespace：</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-6>6</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># velero uninstall</span>
</span></span><span style=display:flex><span>You are about to uninstall Velero.
</span></span><span style=display:flex><span>Are you sure you want to <span style=color:#007020;font-weight:700>continue</span> <span style=color:#666>(</span>Y/N<span style=color:#666>)</span>? y
</span></span><span style=display:flex><span>Velero uninstalled ⛵
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># kubectl delete namespace/velero clusterrolebinding/velero</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># kubectl delete crds -l component=velero</span></span></span></code></pre></td></tr></table></div></div></div><h3 id=备份中遇到异常>备份中遇到异常</h3><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-5>5</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>time=&#34;2021-09-07T07:22:35Z&#34; level=info msg=&#34;Validating backup storage location&#34; backup-storage-location=default controller=backup-storage-location logSource=&#34;pkg/controller/backup_storage_location_controller.go:114&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>time=&#34;2021-09-07T07:22:36Z&#34; level=info msg=&#34;Backup storage location is invalid, marking as unavailable&#34; backup-storage-location=default controller=backup-storage-location logSource=&#34;pkg/controller/backup_storage_location_controller.go:117&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>time=&#34;2021-09-07T07:22:36Z&#34; level=error msg=&#34;Error listing backups in backup store&#34; backupLocation=default controller=backup-sync error=&#34;rpc error: code = Unknown desc = RequestError: send request failed\ncaused by: Get http://minio.velero.svc:9000/velero?delimiter=%2F&amp;list-type=2&amp;prefix=backups%2F: dial tcp: lookup minio.velero.svc on 10.96.0.10:53: no such host&#34; error.file=&#34;/go/src/velero-plugin-for-aws/velero-plugin-for-aws/object_store.go:361&#34; error.function=&#34;main.(*ObjectStore).ListCommonPrefixes&#34; logSource=&#34;pkg/controller/backup_sync_controller.go:182&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>time=&#34;2021-09-07T07:22:36Z&#34; level=error msg=&#34;Current backup storage locations available/unavailable/unknown: 0/1/0, Backup storage location \&#34;default\&#34; is unavailable: rpc error: code = Unknown desc = RequestError: send request failed\ncaused by: Get http://minio.velero.svc:9000/velero?delimiter=%2F&amp;list-type=2&amp;prefix=: dial tcp: lookup minio.velero.svc on 10.96.0.10:53: no such host)&#34; controller=backup-storage-location logSource=&#34;pkg/controller/backup_storage_location_controller.go:164&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>time=&#34;2021-09-07T07:22:36Z&#34; level=error msg=&#34;Current backup storage locations available/unavailable/unknown: 0/1/0)&#34; controller=backup-storage-location logSource=&#34;pkg/controller/backup_storage_location_controller.go:166&#34;</span></span></code></pre></td></tr></table></div></div></div><p>说明CRD资源BackupStorageLocation信息以及对象存储账户和自己设置的不一致，由于重新安装没有清理干净旧的资源信息</p><p>这里重新安装即可：</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-38>38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-39>39</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># velero uninstall</span>
</span></span><span style=display:flex><span>You are about to uninstall Velero.
</span></span><span style=display:flex><span>Are you sure you want to <span style=color:#007020;font-weight:700>continue</span> <span style=color:#666>(</span>Y/N<span style=color:#666>)</span>? y
</span></span><span style=display:flex><span>Velero uninstalled ⛵
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># kubectl delete namespace/velero clusterrolebinding/velero</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># kubectl delete crds -l component=velero</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># velero install \</span>
</span></span><span style=display:flex><span>    --provider aws <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>    --plugins velero/velero-plugin-for-aws:v1.2.0 <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>    --bucket k8s-jf <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>    --secret-file ./credentials-velero <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>    --use-volume-snapshots<span style=color:#666>=</span><span style=color:#007020>false</span> <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>    --backup-location-config <span style=color:#bb60d5>region</span><span style=color:#666>=</span>minio,s3ForcePathStyle<span style=color:#666>=</span><span style=color:#4070a0>&#34;true&#34;</span>,s3Url<span style=color:#666>=</span>http://192.168.1.214:39000
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># kubectl -n velero get backupstoragelocation default -o yaml #查看资源信息已经是自己想要的</span>
</span></span><span style=display:flex><span>apiVersion: velero.io/v1
</span></span><span style=display:flex><span>kind: BackupStorageLocation
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  creationTimestamp: <span style=color:#4070a0>&#34;2021-09-07T07:47:44Z&#34;</span>
</span></span><span style=display:flex><span>  generation: <span style=color:#40a070>1</span>
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    component: velero
</span></span><span style=display:flex><span>  name: default
</span></span><span style=display:flex><span>  namespace: velero
</span></span><span style=display:flex><span>  resourceVersion: <span style=color:#4070a0>&#34;1184696&#34;</span>
</span></span><span style=display:flex><span>  selfLink: /apis/velero.io/v1/namespaces/velero/backupstoragelocations/default
</span></span><span style=display:flex><span>  uid: 39502e43-272e-461f-a114-a9ec955f0510
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  config:
</span></span><span style=display:flex><span>    region: minio
</span></span><span style=display:flex><span>    s3ForcePathStyle: <span style=color:#4070a0>&#34;true&#34;</span>
</span></span><span style=display:flex><span>    s3Url: http://192.168.1.214:39000
</span></span><span style=display:flex><span>  default: <span style=color:#007020>true</span>
</span></span><span style=display:flex><span>  objectStorage:
</span></span><span style=display:flex><span>    bucket: k8s-jf
</span></span><span style=display:flex><span>  provider: aws
</span></span><span style=display:flex><span>status:
</span></span><span style=display:flex><span>  lastSyncedTime: <span style=color:#4070a0>&#34;2021-09-07T07:50:00Z&#34;</span>
</span></span><span style=display:flex><span>  lastValidationTime: <span style=color:#4070a0>&#34;2021-09-07T07:50:00Z&#34;</span>
</span></span><span style=display:flex><span>  phase: Available            </span></span></code></pre></td></tr></table></div></div></div></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>wanzi</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2021-09-11</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><div class=post-reward><input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>Reward</label><div class=qr-code></div></div><footer class=post-footer><div class=post-tags><a href=/tags/velero/>velero</a>
<a href=/tags/k8s/>k8s</a>
<a href=/tags/%E5%A4%87%E4%BB%BD/>备份</a>
<a href=/tags/keepalived/>keepalived</a></div><nav class=post-nav><a class=prev href=/post/prometheus-prometheusalert-alertmanager/><i class=iconfont></i><span class="prev-text nav-default">利用Prometheusalert打造Prometheus告警消息聚合</span>
<span class="prev-text nav-mobile">Prev</span>
</a><a class=next href=/post/greenplum-docker-compose-installtion/><span class="next-text nav-default">如何快速搭建一套Greenplum集群</span>
<span class="prev-text nav-mobile">Next</span>
<i class=iconfont></i></a></nav></footer></article><div class=comment><script src=https://giscus.app/client.js data-repo=wzdushu/wzdushu data-repo-id=R_kgDOJYMw-w data-category=Announcements data-category-id=DIC_kwDOJYMw-84CV244 data-mapping=pathname data-strict=1 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><div id=remark42></div></div><nav class=toc id=toc><div class=toc-title>Table of Contents</div><div class="toc-content custom-scrollbar"><nav id=TableOfContents><ul><li><a href=#备份etcd>备份ETCD</a></li><li><a href=#minio对象存储服务搭建>minio对象存储服务搭建</a></li><li><a href=#velero备份之安装客户端>velero备份之安装客户端</a></li><li><a href=#velero备份之k8s部署velero>velero备份之k8s部署velero</a></li><li><a href=#velero备份之velero命令>velero备份之velero命令</a><ul><li><a href=#备份查看删除操作>备份,查看,删除操作</a></li><li><a href=#定时备份>定时备份：</a></li><li><a href=#备份恢复>备份恢复：</a></li></ul></li><li><a href=#velero备份实战>velero备份实战</a><ul><li><a href=#velero对集群进行一次完整备份>velero对集群进行一次完整备份：</a></li><li><a href=#设置4小时定时备份一次备份保留2个月>设置4小时定时备份一次，备份保留2个月：</a></li><li><a href=#同集群下手动从完整备份中恢复其中一个namespace到指定namespace>同集群下，手动从完整备份中恢复其中一个namespace到指定namespace</a></li><li><a href=#跨集群将定期备份数据恢复>跨集群，将定期备份数据恢复</a></li><li><a href=#查看已经备份数据>查看已经备份数据：</a></li><li><a href=#恢复指定命名空间数据>恢复指定命名空间数据</a></li><li><a href=#卸载velero>卸载velero</a></li><li><a href=#备份中遇到异常>备份中遇到异常</a></li></ul></li></ul></nav></div></nav></div></main><footer id=footer class=footer><div class=social-icon-links><a href rel="me noopener" class=social-icon-link title=github target=_blank></a><a href=/index.xml rel="noopener alternate" type=application/rss+xml class=social-icon-link title=rss target=_blank></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span><span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span><span class=copyright-year>&copy;
2018 -
2024
<span class=heart><i class=iconfont></i></span><span class=author>丸子有记
</span></span><span id=busuanzi_container>访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span><span><a href=https://www.foreverblog.cn/ target=_blank><img src=https://img.foreverblog.cn/logo_en_default.png alt style=width:auto;height:16px> </a>|<a href=https://beian.miit.gov.cn target=_blank>京ICP备2021004162号-1</a></span></div></footer><script type=text/javascript src=/js/main.f4eecbfe30294759805b8c3f5cdd257f04ee0660ed2b189b23ba933aa085253f.js integrity="sha256-9O7L/jApR1mAW4w/XN0lfwTuBmDtKxibI7qTOqCFJT8=" crossorigin=anonymous></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script id=baidu_analytics>var _hmt=_hmt||[];(function(){if(window.location.hostname==="localhost")return;var t,e=document.createElement("script");e.async=!0,e.src="https://hm.baidu.com/hm.js?<script> var _hmt = _hmt || [];(function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?9f80634ead11eb9ce00a6452d8891ed7"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script>",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script><script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script>var remark_config={host:"https://remark42.example.com",site_id:"remark",components:["embed","counter"]};!function(e,t){for(s=0;s<e.length;s++){var s,n=t.createElement("script"),o=".js",i=t.head||t.body;"noModule"in n?(n.type="module",o=".mjs"):n.async=!0,n.defer=!0,n.src=remark_config.host+"/web/"+e[s]+o,i.appendChild(n)}}(remark_config.components||["embed"],document)</script></body></html>