<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage data-theme=light><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>ArgoCD配合Jenkins Pipeline自动化部署应用 - 丸子有记
</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=color-scheme content="light dark"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=author content="wanzi"><meta name=description content="ArgoCD配合Jenkins Pipeline自动化部署群"><meta name=keywords content="丸子有记,运维,devops,sre,运维架构,运维开发,go语言,python"><meta name=generator content="Hugo 0.121.0"><link rel=canonical href=/post/cicd-argocd-jenkins-pipeline.zh-cn/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/css/style.min.4d9e22c6c4a4cfe9ca1e35f9578ca6c8ff84c408a5f0599c8cbdaf444e95eae8.css integrity="sha256-TZ4ixsSkz+nKHjX5V4ymyP+ExAil8FmcjL2vRE6V6ug=" media=screen crossorigin=anonymous><meta property="og:title" content="ArgoCD配合Jenkins Pipeline自动化部署应用"><meta property="og:description" content="ArgoCD配合Jenkins Pipeline自动化部署群"><meta property="og:type" content="article"><meta property="og:url" content="/post/cicd-argocd-jenkins-pipeline.zh-cn/"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-07-29T15:22:42+08:00"><meta property="article:modified_time" content="2020-07-29T17:22:42+08:00"><meta itemprop=name content="ArgoCD配合Jenkins Pipeline自动化部署应用"><meta itemprop=description content="ArgoCD配合Jenkins Pipeline自动化部署群"><meta itemprop=datePublished content="2020-07-29T15:22:42+08:00"><meta itemprop=dateModified content="2020-07-29T17:22:42+08:00"><meta itemprop=wordCount content="751"><meta itemprop=keywords content="argocd,k8s,"><meta name=twitter:card content="summary"><meta name=twitter:title content="ArgoCD配合Jenkins Pipeline自动化部署应用"><meta name=twitter:description content="ArgoCD配合Jenkins Pipeline自动化部署群"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--><script>(function(){var e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e)})()</script></head><body><div id=back-to-top></div><header><div class=desktop-header><div class=desktop-header-logo><a href=/ class=logo>丸子有记</a></div><nav class=desktop-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/notes/>Notes</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li><li class=menu-item><a id=openSearch class="menu-item-link menu-item-search" href=#></a></li><li class=menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);></a></li><li class=menu-item><a class=menu-item-link href=/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank></a></li></ul></nav></div><div class=mobile-header><div id=mobile-navbar class=mobile-navbar><div id=mobile-navbar-icon class=mobile-navbar-icon></div><div class=mobile-navbar-logo><a href=/%20/ class=logo>丸子有记</a></div></div><div id=mobile-menu-close-modal class=mobile-menu-close-modal></div><nav id=mobile-menu class=mobile-menu><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=/>Home</a></li><li class=mobile-menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=mobile-menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=mobile-menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=mobile-menu-item><a class=menu-item-link href=/notes/>Notes</a></li><li class=mobile-menu-item><a class=menu-item-link href=/about/>About</a></li><li class=mobile-menu-item><a id=openSearchMobile class="mobile-menu-item-link menu-item-search" href=#></a></li><li class=mobile-menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);></a></li><li class=mobile-menu-item><a class=menu-item-link href=/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank></a></li></ul></nav></div></header><main id=main class="main pico container"><div class=content-wrapper><aside class=sidebar></aside><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>ArgoCD配合Jenkins Pipeline自动化部署应用</h1><div class=post-meta-list><div class="post-meta-item post-meta-author"><a href=/about><span class=post-meta-author-name>wanzi</span></a></div><div class="post-meta-item post-meta-time"><time datetime=2020-07-29>2020-07-29</time></div><div class=post-meta__right><span class=post-meta-more>751 words -
2 min read
- <span class=remark42__counter data-url=/post/cicd-argocd-jenkins-pipeline.zh-cn/></span> Comments</span><div class="post-meta-item post-meta-category"><a href=/categories/cicd/>cicd</a></div><span id=busuanzi_container_page_pv>| 阅读 <span id=busuanzi_value_page_pv></span></span></div></div></header><div class=post-content><h2 id=创建helm仓库>创建helm仓库</h2><p>首先，创建基础Helm模版仓库：</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm create template .</span></span></code></pre></td></tr></table></div></div></div><p>对于实际的部署中，需要根据自己的业务定制自己的helm模版，我这里直接使用我们内部自定义的通用模版，方便快速部署;另外也可以参考bitnami家维护的helm chart(<a href=https://github.com/bitnami/charts/tree/master/bitnami>https://github.com/bitnami/charts/tree/master/bitnami</a>)</p><h2 id=jenkins凭证配置argocd-token信息>jenkins凭证配置argocd token信息</h2><p><img src=/images/2020/argocd-jenkins-001.png alt="argocd and jenkins"></p><h2 id=配置jenkins-pipeline编写>配置jenkins pipeline编写</h2><p>这里我们以gotest项目(<a href=https://code.test.cn/hqliang/gotest>https://code.test.cn/hqliang/gotest</a>)为例</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-38>38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-39>39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-40>40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-41>41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-42>42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-43>43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-44>44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-45>45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-46>46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-47>47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-48>48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-49>49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-50>50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-51>51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-52>52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-53>53</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>pipeline {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>environment {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>GOPROXY = &#34;http://repo.test.cn/repository/goproxy/&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>HUB_URL = &#34;registry.test.cn&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>ARGOCD_SERVER=&#34;qacd.test.cn&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>ARGOCD_PROJ=&#34;test-project&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>ARGOCD_APP=&#34;gotest&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>ARGOCD_REPO=&#34;https://code.test.cn/devops/cicd/qa.git&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>ARGOCD_PATH=&#34;devops/gotest&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>ARGOCD_CLUSTER=&#34;https://172.16.19.250:8443&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>ARGOCD_NS=&#34;default&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>agent {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>node {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>label &#39;aiops&#39;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>stages {      <span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>stage (&#39;Docker_Build&#39;) {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>steps {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#062873;font-weight:700>withCredentials([[$class</span>:<span style=color:#bbb> </span><span style=color:#4070a0>&#39;UsernamePasswordMultiBinding&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#062873;font-weight:700>credentialsId</span>:<span style=color:#bbb> </span><span style=color:#4070a0>&#39;12ff2942-972c-4df3-8d2d-2cfcb25e00de&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#062873;font-weight:700>usernameVariable</span>:<span style=color:#bbb> </span><span style=color:#4070a0>&#39;DOCKER_HUB_USER&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#062873;font-weight:700>passwordVariable</span>:<span style=color:#bbb> </span><span style=color:#4070a0>&#39;DOCKER_HUB_PASSWORD&#39;</span>]]) {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>sh &#39;&#39;&#39;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>TAG=$(git describe --tags  `git rev-list --tags --max-count=1`)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                            </span>docker login registry.test.cn -u ${DOCKER_HUB_USER} -p ${DOCKER_HUB_PASSWORD}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                            </span>make docker-all VERSION=$TAG<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#4070a0>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#4070a0>            }
</span></span></span><span style=display:flex><span><span style=color:#4070a0>            }
</span></span></span><span style=display:flex><span><span style=color:#4070a0>        }
</span></span></span><span style=display:flex><span><span style=color:#4070a0> 
</span></span></span><span style=display:flex><span><span style=color:#4070a0>        stage (&#39;</span>Deploy_K8S&#39;) {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>             </span>steps {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                     </span><span style=color:#062873;font-weight:700>withCredentials([string(credentialsId</span>:<span style=color:#bbb> </span><span style=color:#4070a0>&#34;qa-argocd&#34;</span><span style=color:#062873;font-weight:700>, variable</span>:<span style=color:#bbb> </span><span style=color:#4070a0>&#39;ARGOCD_AUTH_TOKEN&#39;</span>)]) {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span>sh &#39;&#39;&#39;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>TAG=$(git describe --tags  `git rev-list --tags --max-count=1`)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#60a0b0;font-style:italic># create app</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>ARGOCD_SERVER=$ARGOCD_SERVER argocd --grpc-web app create $ARGOCD_APP --project $ARGOCD_PROJ --repo $ARGOCD_REPO --path $ARGOCD_PATH --dest-namespace  $ARGOCD_NS --dest-server $ARGOCD_CLUSTER --upsert --insecure<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span><span style=color:#60a0b0;font-style:italic># deploy app</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span>ARGOCD_SERVER=$ARGOCD_SERVER argocd --grpc-web app set $ARGOCD_APP -p containers.tag=$TAG  --insecure<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span><span style=color:#60a0b0;font-style:italic># Deploy to ArgoCD</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span>ARGOCD_SERVER=$ARGOCD_SERVER argocd --grpc-web app sync $ARGOCD_APP  --force --insecure<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span>ARGOCD_SERVER=$ARGOCD_SERVER argocd --grpc-web app wait $ARGOCD_APP  --timeout 600 --insecure<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span><span style=color:#4070a0>&#39;&#39;</span>&#39;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>               </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}</span></span></code></pre></td></tr></table></div></div></div><h2 id=配置gitlab-webhook触发jenkins>配置gitlab webhook触发Jenkins</h2><h3 id=jenkins配置触发构建>jenkins配置触发构建</h3><p><img src=/images/2020/argocd-jenkins-002.png alt="argocd and jenkins"></p><h3 id=gitlab配置webhook>gitlab配置webhook</h3><p><img src=/images/2020/argocd-jenkins-003.png alt="argocd and jenkins"></p><h3 id=推送tag到远端分支>推送tag到远端分支</h3><p><img src=/images/2020/argocd-jenkins-004.png alt="argocd and jenkins"></p><h3 id=jenkins-pipeline构建>jenkins pipeline构建</h3><p>到jenkins查看pipeline构建结果如下：</p><p>docker自动打包并推送到harbor上
<img src=/images/2020/argocd-jenkins-005.png alt="argocd and jenkins"></p><p>创建Argo应用并同步部署到k8s集群
<img src=/images/2020/argocd-jenkins-006.png alt="argocd and jenkins"></p><p>最后查看同步状态，途中说明已经正常发布到k8s集群：
<img src=/images/2020/argocd-jenkins-007.png alt="argocd and jenkins"></p><p>我们到argocd的dashboard看一下应用流程图，应用各个组件已经正常运行。
<img src=/images/2020/argocd-jenkins-008.png alt="argocd and jenkins"></p><p>通过kubectl获取已经创建好的资源：
<img src=/images/2020/argocd-jenkins-009.png alt="argocd and jenkins"></p><p>最后验证一下业务是否可以访问呢，访问http://gotest.test.cn/df 即可查看容器磁盘空间</p><p><img src=/images/2020/argocd-jenkins-010.png alt="argocd and jenkins"></p><h2 id=总结优化>总结&优化</h2><p>无论通过jenkins的pipeline还是通过gitlab CI我们都可以更好的整合argocd,最终实现一键部署业务应用.</p></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>wanzi</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2020-07-29</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><div class=post-reward><input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>Reward</label><div class=qr-code></div></div><footer class=post-footer><div class=post-tags><a href=/tags/argocd/>argocd</a>
<a href=/tags/k8s/>k8s</a></div><nav class=post-nav><a class=prev href=/post/devops-terraform-about.zh-cn/><i class=iconfont></i><span class="prev-text nav-default">自动化编排工具Terraform介绍</span>
<span class="prev-text nav-mobile">Prev</span>
</a><a class=next href=/post/kubernetes-error-no-space-left-on-device.zh-cn/><span class="next-text nav-default">argocd部署deployment出现: no space left on device</span>
<span class="prev-text nav-mobile">Next</span>
<i class=iconfont></i></a></nav></footer></article><div class=comment><script src=https://giscus.app/client.js data-repo=wzdushu/wzdushu.github.io data-repo-id=R_kgDONA8Shg data-category=General data-category-id=DIC_kwDONA8Shs4CjwIH data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><div id=remark42></div></div><nav class=toc id=toc><div class=toc-title>Table of Contents</div><div class="toc-content custom-scrollbar"><nav id=TableOfContents><ul><li><a href=#创建helm仓库>创建helm仓库</a></li><li><a href=#jenkins凭证配置argocd-token信息>jenkins凭证配置argocd token信息</a></li><li><a href=#配置jenkins-pipeline编写>配置jenkins pipeline编写</a></li><li><a href=#配置gitlab-webhook触发jenkins>配置gitlab webhook触发Jenkins</a><ul><li><a href=#jenkins配置触发构建>jenkins配置触发构建</a></li><li><a href=#gitlab配置webhook>gitlab配置webhook</a></li><li><a href=#推送tag到远端分支>推送tag到远端分支</a></li><li><a href=#jenkins-pipeline构建>jenkins pipeline构建</a></li></ul></li><li><a href=#总结优化>总结&优化</a></li></ul></nav></div></nav></div></main><footer id=footer class=footer><div class=social-icon-links><a href rel="me noopener" class=social-icon-link title=github target=_blank></a><a href=/index.xml rel="noopener alternate" type=application/rss+xml class=social-icon-link title=rss target=_blank></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span><span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span><span class=copyright-year>&copy;
2018 -
2024
<span class=heart><i class=iconfont></i></span><span class=author>丸子有记
</span></span><span id=busuanzi_container>访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span><span><a href=https://www.foreverblog.cn/ target=_blank><img src=https://img.foreverblog.cn/logo_en_default.png alt style=width:auto;height:16px> </a>|<a href=https://beian.miit.gov.cn target=_blank>京ICP备2021004162号-1</a></span></div></footer><script type=text/javascript src=/js/main.f4eecbfe30294759805b8c3f5cdd257f04ee0660ed2b189b23ba933aa085253f.js integrity="sha256-9O7L/jApR1mAW4w/XN0lfwTuBmDtKxibI7qTOqCFJT8=" crossorigin=anonymous></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script id=baidu_analytics>var _hmt=_hmt||[];(function(){if(window.location.hostname==="localhost")return;var t,e=document.createElement("script");e.async=!0,e.src="https://hm.baidu.com/hm.js?<script> var _hmt = _hmt || [];(function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?9f80634ead11eb9ce00a6452d8891ed7"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script>",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script><script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script>var remark_config={host:"https://remark42.example.com",site_id:"remark",components:["embed","counter"]};!function(e,t){for(s=0;s<e.length;s++){var s,n=t.createElement("script"),o=".js",i=t.head||t.body;"noModule"in n?(n.type="module",o=".mjs"):n.async=!0,n.defer=!0,n.src=remark_config.host+"/web/"+e[s]+o,i.appendChild(n)}}(remark_config.components||["embed"],document)</script></body></html>