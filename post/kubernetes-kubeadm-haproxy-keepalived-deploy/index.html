<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage data-theme=light><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>kubeadm deploys a highly available kubernetes cluster - 丸子有记
</title><link rel=alternate hreflang=zh-cn href=/zh-cn/post/kubernetes-kubeadm-haproxy-keepalived-deploy/><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=color-scheme content="light dark"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=author content="wanzi"><meta name=description content="kubeadm deploys a highly available kubernetes cluster"><meta name=keywords content="丸子有记,运维,devops,sre,运维架构,运维开发,golang,python,rust"><meta name=generator content="Hugo 0.121.0"><link rel=canonical href=/post/kubernetes-kubeadm-haproxy-keepalived-deploy/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/css/style.min.4d9e22c6c4a4cfe9ca1e35f9578ca6c8ff84c408a5f0599c8cbdaf444e95eae8.css integrity="sha256-TZ4ixsSkz+nKHjX5V4ymyP+ExAil8FmcjL2vRE6V6ug=" media=screen crossorigin=anonymous><meta property="og:title" content="kubeadm deploys a highly available kubernetes cluster"><meta property="og:description" content="kubeadm deploys a highly available kubernetes cluster"><meta property="og:type" content="article"><meta property="og:url" content="/post/kubernetes-kubeadm-haproxy-keepalived-deploy/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-08-15T17:22:42+08:00"><meta property="article:modified_time" content="2021-08-15T17:22:42+08:00"><meta itemprop=name content="kubeadm deploys a highly available kubernetes cluster"><meta itemprop=description content="kubeadm deploys a highly available kubernetes cluster"><meta itemprop=datePublished content="2021-08-15T17:22:42+08:00"><meta itemprop=dateModified content="2021-08-15T17:22:42+08:00"><meta itemprop=wordCount content="2602"><meta itemprop=keywords content="kubeadm,k8s,haproxy,keepalived,"><meta name=twitter:card content="summary"><meta name=twitter:title content="kubeadm deploys a highly available kubernetes cluster"><meta name=twitter:description content="kubeadm deploys a highly available kubernetes cluster"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--><script>(function(){var e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e)})()</script></head><body><div id=back-to-top></div><header><div class=desktop-header><div class=desktop-header-logo><a href=/ class=logo>丸子有记</a></div><nav class=desktop-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li><li class=menu-item><a class="menu-item-link menu-parent menu-item-lang" href=#><svg aria-hidden="true" class="lucide lucide-languages hi-svg-inline icon--languages" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>English</a><ul class=submenu><li class=submenu-item><a href=/zh-cn/>中文</a></li></ul></li><li class=menu-item><a id=openSearch class="menu-item-link menu-item-search" href=#><svg aria-hidden="true" class="lucide lucide-search hi-svg-inline icon--search" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></a></li><li class=menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);><svg aria-hidden="true" class="lucide lucide-sun hi-svg-inline theme-icon-light" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg><svg aria-hidden="true" class="lucide lucide-moon hi-svg-inline theme-icon-dark" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></a></li><li class=menu-item><a class=menu-item-link href=/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline icon--rss" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav></div><div class=mobile-header><div id=mobile-navbar class=mobile-navbar><div id=mobile-navbar-icon class=mobile-navbar-icon><svg aria-hidden="true" class="lucide lucide-menu hi-svg-inline icon--menu" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg></div><div class=mobile-navbar-logo><a href=/%20/ class=logo>丸子有记</a></div></div><div id=mobile-menu-close-modal class=mobile-menu-close-modal></div><nav id=mobile-menu class=mobile-menu><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=/>Home</a></li><li class=mobile-menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=mobile-menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=mobile-menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=mobile-menu-item><a class=menu-item-link href=/about/>About</a></li><li class=mobile-menu-item><div class="mobile-menu-parent mobile-menu-item-lang"><span class=mobile-submenu-open></span>
<a href=#><svg aria-hidden="true" class="lucide lucide-languages hi-svg-inline icon--languages" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>English
Language</a></div><ul class=mobile-submenu-list><li><a href=/zh-cn/>中文</a></li><li><a href=/><strong>English</strong></a></li></ul></li><li class=mobile-menu-item><a id=openSearchMobile class="mobile-menu-item-link menu-item-search" href=#><svg aria-hidden="true" class="lucide lucide-search hi-svg-inline icon--search" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></a></li><li class=mobile-menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);><svg aria-hidden="true" class="lucide lucide-sun hi-svg-inline theme-icon-light" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg><svg aria-hidden="true" class="lucide lucide-moon hi-svg-inline theme-icon-dark" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></a></li><li class=mobile-menu-item><a class=menu-item-link href=/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline icon--rss" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav></div></header><main id=main class="main pico container"><div class=content-wrapper><aside class=sidebar></aside><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>kubeadm deploys a highly available kubernetes cluster</h1><div class=post-title-i18n><svg aria-hidden="true" class="lucide lucide-languages hi-svg-inline icon--languages" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg><div><a href=/zh-cn/post/kubernetes-kubeadm-haproxy-keepalived-deploy/>zh-cn</a></div></div><div class=post-meta-list><div class="post-meta-item post-meta-author"><svg aria-hidden="true" class="lucide lucide-user-round-pen hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2 21a8 8 0 0110.821-7.487"/><path d="M21.378 16.626a1 1 0 00-3.004-3.004l-4.01 4.012a2 2 0 00-.506.854l-.837 2.87a.5.5.0 00.62.62l2.87-.837a2 2 0 00.854-.506z"/><circle cx="10" cy="8" r="5"/></svg><a href=/about><span class=post-meta-author-name>wanzi</span></a></div><div class="post-meta-item post-meta-time"><svg aria-hidden="true" class="lucide lucide-calendar-days hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg><time datetime=2021-08-15>2021-08-15</time></div><div class=post-meta__right><span class=post-meta-more>2602 words -
6 min read
- <span class=remark42__counter data-url=/post/kubernetes-kubeadm-haproxy-keepalived-deploy/></span> Comments</span><div class="post-meta-item post-meta-category"><a href=/categories/kubernetes/>kubernetes</a></div></div></div></header><div class=post-content><p>In order to verify the private deployment later
, the intranet environment needs to quickly build a k8s cluster. Because I usually use kubeasz and kubespray to handle large-scale clusters before, this time for small environment clusters, it will be more efficient to directly use kubeadm to deploy.</p><p>The following records the kubeadm deployment process:</p><p>Cluster nodes:</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4>4</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#40a070>192.168.1.206</span><span style=color:#bbb> </span>sd-cluster-206 node<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#40a070>192.168.1.207</span><span style=color:#bbb> </span>sd-cluster-207 master,etcd<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#40a070>192.168.1.208</span><span style=color:#bbb> </span>sd-cluster-208 master,etcd,haproxy,keepalived<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#40a070>192.168.1.209</span><span style=color:#bbb> </span>sd-cluster-209 master,etcd,haproxy,keepalived</span></span></code></pre></td></tr></table></div></div></div><p>Image version:</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3>3</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.18.3
</span></span><span style=display:flex><span>docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.18.3
</span></span><span style=display:flex><span>docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.18.3 docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.18.3 docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.6.5 docker pull registry.cn-hangzhou.aliyuncs. com/google_containers/etcd:3.4.3-0 docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.2 docker pull registry.cn-shanghai.aliyuncs.com/gcr-k8s/flannel:v0.14.0 docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v0.48.1</span></span></code></pre></td></tr></table></div></div></div><h2 id=1-basic-environment-settings>1. Basic environment settings</h2><h3 id=1-install-docker-and-add-hosts>1. Install docker and add hosts</h3><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-6>6</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>yum install -y yum-utils device-mapper-persistent-data lvm2 git
</span></span><span style=display:flex><span>yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</span></span><span style=display:flex><span>yum install docker-ce -y
</span></span><span style=display:flex><span>systemctl start docker
</span></span><span style=display:flex><span>systemctl <span style=color:#007020>enable</span> docker
</span></span><span style=display:flex><span>systemctl status docker</span></span></code></pre></td></tr></table></div></div></div><h3 id=2-configure-hosts>2. Configure hosts</h3><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-5>5</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat &gt;&gt; /etc/hosts <span style=color:#4070a0>&lt;&lt; hhhh
</span></span></span><span style=display:flex><span><span style=color:#4070a0>192.168.1.207 sd-cluster-207
</span></span></span><span style=display:flex><span><span style=color:#4070a0>192.168.1.208 sd-cluster-208
</span></span></span><span style=display:flex><span><span style=color:#4070a0>192.168.1.209 sd-cluster-209
</span></span></span><span style=display:flex><span><span style=color:#4070a0>hhhh</span></span></span></code></pre></td></tr></table></div></div></div><h3 id=3-disable-the-firewall-and-set-selinux>3. Disable the firewall and set selinux</h3><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-4>4</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl stop firewalld
</span></span><span style=display:flex><span>systemctl disable firewalld
</span></span><span style=display:flex><span>setenforce <span style=color:#40a070>0</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#4070a0>&#39;s/SELINUX=permissive/SELINUX=disabled/&#39;</span> /etc/sysconfig/selinux</span></span></code></pre></td></tr></table></div></div></div><h3 id=4-turn-off-swap>4. Turn off swap</h3><p>Kubernetes 1.8 requires the system&rsquo;s Swap to be turned off. If it is not turned off, kubelet will not be able to start under the default configuration. Method 1: Change this restriction through the kubelet startup parameter –fail-swap-on=false. Method 2: Turn off the system&rsquo;s Swap.</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># swapoff -a</span></span></span></code></pre></td></tr></table></div></div></div><p>Modify the /etc/fstab file, comment out the automatic mounting of SWAP, and use free -m to confirm that swap has been turned off.</p><h3 id=5-install-kubeadm-kubelet-and-ipvsadm-for-all-nodes>5. Install kubeadm, kubelet, and ipvsadm for all nodes</h3><p>Reference: <a href=https://developer.aliyun.com/mirror/kubernetes>https://developer.aliyun.com/mirror/kubernetes</a></p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-11>11</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4070a0>&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span></span></span><span style=display:flex><span><span style=color:#4070a0>[kubernetes]
</span></span></span><span style=display:flex><span><span style=color:#4070a0>name=Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4070a0>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
</span></span></span><span style=display:flex><span><span style=color:#4070a0>enabled=1
</span></span></span><span style=display:flex><span><span style=color:#4070a0>gpgcheck=1
</span></span></span><span style=display:flex><span><span style=color:#4070a0>repo_gpgcheck=1
</span></span></span><span style=display:flex><span><span style=color:#4070a0>gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span style=display:flex><span><span style=color:#4070a0>EOF</span>
</span></span><span style=display:flex><span>yum install -y --nogpgcheck kubelet-1.18.3 kubeadm-1.18.3 ipvsadm
</span></span><span style=display:flex><span>systemctl <span style=color:#007020>enable</span> kubelet <span style=color:#666>&amp;&amp;</span> systemctl start kubelet</span></span></code></pre></td></tr></table></div></div></div><p>ps: Since the official website does not open the synchronization method, there may be index gpg check failures. In this case, please use yum install -y &ndash;nogpgcheck kubelet kubeadm kubectl installation</p><p>Add ipvsadm. If you restart the computer, you need to reload it (you can write it in /etc/rc.local to automatically load it when you restart the computer)</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-6>6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-7>7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-8>8</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4070a0>&lt;&lt;EOF &gt;&gt; /etc/rc.local
</span></span></span><span style=display:flex><span><span style=color:#4070a0>modprobe ip_vs
</span></span></span><span style=display:flex><span><span style=color:#4070a0>modprobe ip_vs_rr
</span></span></span><span style=display:flex><span><span style=color:#4070a0>modprobe ip_vs_wrr
</span></span></span><span style=display:flex><span><span style=color:#4070a0>modprobe ip_vs_sh
</span></span></span><span style=display:flex><span><span style=color:#4070a0>modprobe nf_conntrack_ipv4
</span></span></span><span style=display:flex><span><span style=color:#4070a0>EOF</span>
</span></span><span style=display:flex><span>chmod +x /etc/rc.local</span></span></code></pre></td></tr></table></div></div></div><h2 id=2-keepalived-cooperates-with-haproxy-to-achieve-high-availability-of-load-balancer>2. Keepalived cooperates with haproxy to achieve high availability of load balancer</h2><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>yum -y install keepalived haproxy</span></span></code></pre></td></tr></table></div></div></div><p>Keepalived configuration</p><p>192.168.1.208 configuration</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-27>27</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>vrrp_script chk_ha {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>script &#34;killall -0 haproxy&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>interval 2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>weight -20<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>vrrp_instance VI_1 {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>state MASTER<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>interface bond0<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>virtual_router_id 33<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>mcast_src_ip 192.168.1.208<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>priority 100<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>nopreempt<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>advert_int 1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>authentication {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>auth_type PASS<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>auth_pass hak8s<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>track_script {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>chk_ha<span style=color:#bbb> </span><span style=color:#60a0b0;font-style:italic>## Execute haproxy monitoring</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>virtual_ipaddress {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#40a070>192.168.1.205</span>/24 ##VIP } } ``` 192.168.1.209 configuration ```yaml vrrp_script chk_ha { script &#34;killall -0 haproxy&#34; interval 2 weight -20 } vrrp_instance VI_1 { state BACKUP interface bond0 virtual_router_id 33 mcast_src_ip 192.168.1.20 9 priority 90 advert_int 1 authentication { auth_type PASS auth_pass hak8s } track_script { chk_ha } virtual_ipaddress { 192.168.1.205/24 } } ```<span style=color:#bbb> </span><span style=color:#60a0b0;font-style:italic>### 2. haproxy configuration The haproxy configuration of the two masters 208 and 209 is the same: ```yaml global log /dev/log local0 maxconn 65535 chroot /var/lib/haproxy pidfile /var/run/haproxy.pid stats socket /var/lib/haproxy/stats stats timeout 30s user haproxy group haproxy daemon defaults log global retries 3 option redispatch option dontlognull timeout connect 5000 timeout client 50000 timeout server 50000 frontend k8s-apiserver bind *:8443 mode tcp balance roundrobin server sd-cluster-04 192.168.1.207:6443 weight 5 check inter 2000 rise 2 fall 3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>server sd-cluster-05 192.168.1.208:6443 weight 3 check inter 2000 rise 2 fall 3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>server sd-cluster-06 192.168.1.209:6443 weight 3 check inter 2000 rise 2 fall 3</span></span></code></pre></td></tr></table></div></div></div><p>At this point, haproxy high availability has been built. To verify, directly shut down the keepalived service on 208 to see if vip has flown to the 209 machine.</p><h2 id=3-kubeadm-initializes-the-k8s-cluster>3. kubeadm initializes the k8s cluster</h2><h3 id=1-initialize-the-first-master>1. Initialize the first master</h3><p>kubeadm-config.yaml configuration</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-17>17</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#kubeadm-config.yaml</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#062873;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#062873;font-weight:700>bootstrapTokens</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:#062873;font-weight:700>groups</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>-system:bootstrappers:kubeadm:default-node-token<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#062873;font-weight:700>token</span>:<span style=color:#bbb> </span>abcdef.0123456789abcdef<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#062873;font-weight:700>ttl</span>:<span style=color:#bbb> </span>24h0m0s<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#062873;font-weight:700>usages</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- signing<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- authentication<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#062873;font-weight:700>kind</span>:<span style=color:#bbb> </span>InitConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#062873;font-weight:700>localAPIEndpoint</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#062873;font-weight:700>advertiseAddress</span>:<span style=color:#bbb> </span><span style=color:#40a070>192.168.1.208</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#062873;font-weight:700>bindPort</span>:<span style=color:#bbb> </span><span style=color:#40a070>6443</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#062873;font-weight:700>nodeRegistration</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#062873;font-weight:700>criSocket: /var/run/dockershim.sock name: sd-cluster-208 taints: - effect: NoSchedule key: node-role.kubernetes.io/master --- apiServer: timeoutForControlPlane: 4m0s apiVersion: kubeadm.k8s.io/v1beta2 certificatesDir: /etc/kubernetes/pki clusterName : kubernetes controlPlaneEndpoint</span>:<span style=color:#bbb> </span><span style=color:#4070a0>&#34;192.168.1.208:8443&#34;</span><span style=color:#bbb> </span><span style=color:#062873;font-weight:700>controllerManager</span>:<span style=color:#bbb> </span>{<span style=color:#062873;font-weight:700>} dns: type: CoreDNS etcd: local: dataDir: /var/lib/etcd imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers kind: ClusterConfiguration kubernetesVersion: v1 .18.3 networking: dnsDomain: cluster.local podSubnet: 10.244.0.0/16 serviceSubnet: 10.96.0.0/16 scheduler</span>:<span style=color:#bbb> </span>{<span style=color:#062873;font-weight:700>} --- apiVersion: kubeproxy.config.k8s.io/v1alpha1 kind: KubeProxyConfiguration mode: ipvs ```` ```shell # kubeadm init --config kubeadm-config.yaml --upload-certs W0828 03:02:37.249435 17451 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io] [ init] Using Kubernetes version: v1.18.3 [preflight] Running pre-flight checks [WARNING IsDockerSystemdCheck]</span>:<span style=color:#bbb> </span>detected &#34;cgroupfs&#34; as the Docker cgroup driver. The recommended driver is &#34;systemd&#34;. Please follow the guide at https://kubernetes .io/docs/setup/cri/ [preflight] Pulling images required for setting up a Kubernetes cluster [preflight] This might take a minute or two, depending on the speed of your internet connection [preflight] You can also perform this action in beforehand using &#39;kubeadm config images pull&#39; [kubelet-start] Writing kubelet environment file with flags to file &#34;/var/lib/kubelet/kubeadm-flags.env&#34; [kubelet-start] Writing kubelet configuration to file &#34;/var/lib/kubelet/config .yaml&#34; [kubelet-start] Starting the kubelet [certs] Using certificateDir folder &#34;/etc/kubernetes/pki&#34; [certs] Generating &#34;ca&#34; certificate and key [certs] Generating &#34;apiserver&#34; certificate and key [certs] apiserver serving cert is signed for DNS names [sd-cluster-208 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 192.168.1.208 192.168.1.205] [certs] Generating &#34;apiserver-kubelet-client&#34; certificate and key [certs] Generating &#34;front-proxy-ca&#34; certificate and key [certs] Generating &#34;front-proxy-client&#34; certificate and key [certs] Generating &#34;etcd/ca&#34; certificate and key [certs] Generating &#34;etcd/server&#34; certificate and key [certs] etcd/server serving cert is signed for DNS names [sd-cluster-208 localhost] and IPs [192.168.1.208 127.0.0.1 ::1] [certs] Generating &#34;etcd/peer&#34; certificate and key [certs] etcd/peer serving cert is signed for DNS names [sd-cluster-208 localhost] and IPs [192.168.1.208 127.0.0.1 ::1] [certs] Generating &#34;etcd/healthcheck-client&#34; certificate and key [certs] Generating &#34;apiserver-etcd-client&#34; certificate and key [certs] Generating &#34;sa&#34; key and public key [kubeconfig] Using kubeconfig folder &#34; /etc/kubernetes&#34; [endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address [kubeconfig] Writing &#34;admin.conf&#34; kubeconfig file [endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address [kubeconfig] Writing &#34;kubelet.conf&#34; kubeconfig file [endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address [kubeconfig] Writing &#34;controller-manager.conf&#34; kubeconfig file [endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address [kubeconfig] Writing &#34;scheduler.conf&#34; kubeconfig file [control-plane] Using manifest folder &#34;/etc/kubernetes/manifests&#34; [control-plane] Creating static Pod manifest for &#34;kube-apiserver&#34; [control-plane] Creating static Pod manifest for &#34;kube-controller-manager&#34; W0828 03:02:43.787797 17451 manifests.go:225] the default kube-apiserver authorization-mode is &#34;Node,RBAC&#34;; using &#34;Node,RBAC&#34; [control-plane] Creating static Pod manifest for &#34;kube-scheduler&#34; W0828 03:02:43.789895 17451 manifests.go:225] the default kube-apiserver authorization-mode is &#34;Node,RBAC&#34;; using &#34;Node,RBAC&#34; [etcd] Creating static Pod manifest for local etcd in &#34;/etc/kubernetes/manifests&#34; [wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory &#34;/etc/kubernetes/manifests&#34;. This can take up to 4m0s [apiclient] All control plane components are healthy after 23.015352 seconds [upload-config] Storing the configuration used in ConfigMap &#34;kubeadm-config&#34; in the &#34;kube-system&#34; Namespace [kubelet] Creating a ConfigMap &#34;kubelet-config-1.18&#34; in namespace kube-system with the configuration for the kubelets in the cluster [upload-certs] Storing the certificates in Secret &#34;kubeadm-certs&#34; in the &#34;kube-system&#34; Namespace [upload-certs] Using certificate key:0adac55426d376e72f21ec3aee2465f754e78810700843cb75c270be26eaeaf1 [mark-control-plane] Marking the node sd-cluster-208 as control-plane by adding the label &#34;node-role.kubernetes.io/master=&#39;&#39;&#34; [mark-control-plane] Marking the node sd- cluster-208 as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule] [bootstrap-token] Using token: abcdef.0123456789abcdef [bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles [bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes [bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials [bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token [bootstrap -token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster [bootstrap-token] Creating the &#34;cluster-info&#34; ConfigMap in the &#34;kube-public&#34; namespace [kubelet-finalize] Updating &#34;/etc/kubernetes /kubelet.conf&#34; to point to a rotatable kubelet client certificate and key [addons] Applied essential addon: CoreDNS [endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address [addons] Applied essential addon: kube-proxy Your Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $( id -u):$(id -g) $HOME/.kube/config You should now deploy a pod network to the cluster. Run &#34;kubectl apply -f [podnetwork].yaml&#34; with one of the options listed at: https ://kubernetes.io/docs/concepts/cluster-administration/addons/ You can now join any number of the control-plane node running the following command on each as root: kubeadm join 192.168.1.205:8443 --token abcdef. 0123456789abcdef \ --discovery-token-ca-cert-hash sha256:7400f57a033f7527c80a4b015b54b4b6a88ccb2184ab9a6e39b709fb56e10486 \ --control-plane --certificate-key 0adac55426d376e72f21ec3aee2465f754e78810700843 cb75c270be26eaeaf1 Please note that the certificate-key gives access to cluster sensitive data, keep it secret! As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use &#34;kubeadm init phase upload-certs --upload-certs&#34; to reload certs afterward. Then you can join any number of worker nodes by running the following on each as root: kubeadm join 192.168.1.205:8443 --token abcdef.0123456789abcdef \<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>--discovery-token-ca-cert-hash sha256:7400f57a033f7527c80a4b015b54b4b6a88ccb2184ab9a6e39b709fb56e10486</span></span></code></pre></td></tr></table></div></div></div><p>Configure master node kubeconfig</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-3>3</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mkdir -p <span style=color:#bb60d5>$HOME</span>/.kube
</span></span><span style=display:flex><span>cp -i /etc /kubernetes/admin.conf <span style=color:#bb60d5>$HOME</span>/.kube/config
</span></span><span style=display:flex><span>chown <span style=color:#007020;font-weight:700>$(</span>id -u<span style=color:#007020;font-weight:700>)</span>:<span style=color:#007020;font-weight:700>$(</span>id -g<span style=color:#007020;font-weight:700>)</span> <span style=color:#bb60d5>$HOME</span>/.kube/config</span></span></code></pre></td></tr></table></div></div></div><h3 id=2-new-master-node-joins-the-cluster>2. New master node joins the cluster</h3><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-38>38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-39>39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-40>40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-41>41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-42>42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-43>43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-44>44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-45>45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-46>46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-47>47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-48>48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-49>49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-50>50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-51>51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-52>52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-53>53</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-54>54</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-55>55</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-56>56</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-57>57</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-58>58</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-59>59</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-60>60</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-61>61</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-62>62</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-63>63</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-64>64</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-65>65</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-66>66</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-67><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-67>67</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># kubeadm join 192.168.1.205:8443 --token abcdef.0123456789abcdef \</span>
</span></span><span style=display:flex><span>&gt;     --discovery-token-ca-cert-hash sha256:7400f57a033f7527c80a4b015b54b4b6a88ccb2184ab9a6e39b709fb56e10486 <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>&gt;     --control-plane --certificate-key 0adac55426d376e72f21ec3aee2465f754e78810700843cb75c270be26eaeaf1
</span></span><span style=display:flex><span><span style=color:#666>[</span>preflight<span style=color:#666>]</span> Running pre-flight checks
</span></span><span style=display:flex><span>	<span style=color:#666>[</span>WARNING IsDockerSystemdCheck<span style=color:#666>]</span>: detected <span style=color:#4070a0>&#34;cgroupfs&#34;</span> as the Docker cgroup driver. The recommended driver is <span style=color:#4070a0>&#34;systemd&#34;</span>. Please follow the guide at https://kubernetes.io/docs/setup/cri/
</span></span><span style=display:flex><span><span style=color:#666>[</span>preflight<span style=color:#666>]</span> Reading configuration from the cluster...
</span></span><span style=display:flex><span><span style=color:#666>[</span>preflight<span style=color:#666>]</span> FYI: You can look at this config file with <span style=color:#4070a0>&#39;kubectl -n kube-system get cm kubeadm-config -oyaml&#39;</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>preflight<span style=color:#666>]</span> Running pre-flight checks before initializing the new control plane instance
</span></span><span style=display:flex><span><span style=color:#666>[</span>preflight<span style=color:#666>]</span> Pulling images required <span style=color:#007020;font-weight:700>for</span> setting up a Kubernetes cluster
</span></span><span style=display:flex><span><span style=color:#666>[</span>preflight<span style=color:#666>]</span> This might take a minute or two, depending on the speed of your internet connection
</span></span><span style=display:flex><span><span style=color:#666>[</span>preflight<span style=color:#666>]</span> You can also perform this action in beforehand using <span style=color:#4070a0>&#39;kubeadm config images pull&#39;</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>download-certs<span style=color:#666>]</span> Downloading the certificates in Secret <span style=color:#4070a0>&#34;kubeadm-certs&#34;</span> in the <span style=color:#4070a0>&#34;kube-system&#34;</span> Namespace
</span></span><span style=display:flex><span><span style=color:#666>[</span>certs<span style=color:#666>]</span> Using certificateDir folder <span style=color:#4070a0>&#34;/etc/kubernetes/pki&#34;</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>certs<span style=color:#666>]</span> Generating <span style=color:#4070a0>&#34;front-proxy-client&#34;</span> certificate and key
</span></span><span style=display:flex><span><span style=color:#666>[</span>certs<span style=color:#666>]</span> Generating <span style=color:#4070a0>&#34;etcd/peer&#34;</span> certificate and key
</span></span><span style=display:flex><span><span style=color:#666>[</span>certs<span style=color:#666>]</span> etcd/peer serving cert is signed <span style=color:#007020;font-weight:700>for</span> DNS names <span style=color:#666>[</span>sd-cluster-209 localhost<span style=color:#666>]</span> and IPs <span style=color:#666>[</span>192.168.1.209 127.0.0.1 ::1<span style=color:#666>]</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>certs<span style=color:#666>]</span> Generating <span style=color:#4070a0>&#34;etcd/healthcheck-client&#34;</span> certificate and key
</span></span><span style=display:flex><span><span style=color:#666>[</span>certs<span style=color:#666>]</span> Generating <span style=color:#4070a0>&#34;apiserver-etcd-client&#34;</span> certificate and key
</span></span><span style=display:flex><span><span style=color:#666>[</span>certs<span style=color:#666>]</span> Generating <span style=color:#4070a0>&#34;etcd/server&#34;</span> certificate and key
</span></span><span style=display:flex><span><span style=color:#666>[</span>certs<span style=color:#666>]</span> etcd/server serving cert is signed <span style=color:#007020;font-weight:700>for</span> DNS names <span style=color:#666>[</span>sd-cluster-209 localhost<span style=color:#666>]</span> and IPs <span style=color:#666>[</span>192.168.1.209 127.0.0.1 ::1<span style=color:#666>]</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>certs<span style=color:#666>]</span> Generating <span style=color:#4070a0>&#34;apiserver&#34;</span> certificate and key
</span></span><span style=display:flex><span><span style=color:#666>[</span>certs<span style=color:#666>]</span> apiserver serving cert is signed <span style=color:#007020;font-weight:700>for</span> DNS names <span style=color:#666>[</span>sd-cluster-209 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local<span style=color:#666>]</span> and IPs <span style=color:#666>[</span>10.96.0.1 192.168.1.209 192.168.1.205<span style=color:#666>]</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>certs<span style=color:#666>]</span> Generating <span style=color:#4070a0>&#34;apiserver-kubelet-client&#34;</span> certificate and key
</span></span><span style=display:flex><span><span style=color:#666>[</span>certs<span style=color:#666>]</span> Valid certificates and keys now exist in <span style=color:#4070a0>&#34;/etc/kubernetes/pki&#34;</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>certs<span style=color:#666>]</span> Using the existing <span style=color:#4070a0>&#34;sa&#34;</span> key
</span></span><span style=display:flex><span><span style=color:#666>[</span>kubeconfig<span style=color:#666>]</span> Generating kubeconfig files
</span></span><span style=display:flex><span><span style=color:#666>[</span>kubeconfig<span style=color:#666>]</span> Using kubeconfig folder <span style=color:#4070a0>&#34;/etc/kubernetes&#34;</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>endpoint<span style=color:#666>]</span> WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address
</span></span><span style=display:flex><span><span style=color:#666>[</span>kubeconfig<span style=color:#666>]</span> Writing <span style=color:#4070a0>&#34;admin.conf&#34;</span> kubeconfig file
</span></span><span style=display:flex><span><span style=color:#666>[</span>kubeconfig<span style=color:#666>]</span> Writing <span style=color:#4070a0>&#34;controller-manager.conf&#34;</span> kubeconfig file
</span></span><span style=display:flex><span><span style=color:#666>[</span>kubeconfig<span style=color:#666>]</span> Writing <span style=color:#4070a0>&#34;scheduler.conf&#34;</span> kubeconfig file
</span></span><span style=display:flex><span><span style=color:#666>[</span>control-plane<span style=color:#666>]</span> Using manifest folder <span style=color:#4070a0>&#34;/etc/kubernetes/manifests&#34;</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>control-plane<span style=color:#666>]</span> Creating static Pod manifest <span style=color:#007020;font-weight:700>for</span> <span style=color:#4070a0>&#34;kube-apiserver&#34;</span>
</span></span><span style=display:flex><span>W0828 03:12:57.996811   <span style=color:#40a070>48328</span> manifests.go:225<span style=color:#666>]</span> the default kube-apiserver authorization-mode is <span style=color:#4070a0>&#34;Node,RBAC&#34;</span>; using <span style=color:#4070a0>&#34;Node,RBAC&#34;</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>control-plane<span style=color:#666>]</span> Creating static Pod manifest <span style=color:#007020;font-weight:700>for</span> <span style=color:#4070a0>&#34;kube-controller-manager&#34;</span>
</span></span><span style=display:flex><span>W0828 03:12:58.009390   <span style=color:#40a070>48328</span> manifests.go:225<span style=color:#666>]</span> the default kube-apiserver authorization-mode is <span style=color:#4070a0>&#34;Node,RBAC&#34;</span>; using <span style=color:#4070a0>&#34;Node,RBAC&#34;</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>control-plane<span style=color:#666>]</span> Creating static Pod manifest <span style=color:#007020;font-weight:700>for</span> <span style=color:#4070a0>&#34;kube-scheduler&#34;</span>
</span></span><span style=display:flex><span>W0828 03:12:58.011318   <span style=color:#40a070>48328</span> manifests.go:225<span style=color:#666>]</span> the default kube-apiserver authorization-mode is <span style=color:#4070a0>&#34;Node,RBAC&#34;</span>; using <span style=color:#4070a0>&#34;Node,RBAC&#34;</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>check-etcd<span style=color:#666>]</span> Checking that the etcd cluster is healthy
</span></span><span style=display:flex><span><span style=color:#666>[</span>kubelet-start<span style=color:#666>]</span> Downloading configuration <span style=color:#007020;font-weight:700>for</span> the kubelet from the <span style=color:#4070a0>&#34;kubelet-config-1.18&#34;</span> ConfigMap in the kube-system namespace
</span></span><span style=display:flex><span><span style=color:#666>[</span>kubelet-start<span style=color:#666>]</span> Writing kubelet configuration to file <span style=color:#4070a0>&#34;/var/lib/kubelet/config.yaml&#34;</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>kubelet-start<span style=color:#666>]</span> Writing kubelet environment file with flags to file <span style=color:#4070a0>&#34;/var/lib/kubelet/kubeadm-flags.env&#34;</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>kubelet-start<span style=color:#666>]</span> Starting the kubelet
</span></span><span style=display:flex><span><span style=color:#666>[</span>kubelet-start<span style=color:#666>]</span> Waiting <span style=color:#007020;font-weight:700>for</span> the kubelet to perform the TLS Bootstrap...
</span></span><span style=display:flex><span><span style=color:#666>[</span>etcd<span style=color:#666>]</span> Announced new etcd member joining to the existing etcd cluster
</span></span><span style=display:flex><span><span style=color:#666>[</span>etcd<span style=color:#666>]</span> Creating static Pod manifest <span style=color:#007020;font-weight:700>for</span> <span style=color:#4070a0>&#34;etcd&#34;</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>etcd<span style=color:#666>]</span> Waiting <span style=color:#007020;font-weight:700>for</span> the new etcd member to join the cluster. This can take up to 40s
</span></span><span style=display:flex><span><span style=color:#666>{</span><span style=color:#4070a0>&#34;level&#34;</span>:<span style=color:#4070a0>&#34;warn&#34;</span>,<span style=color:#4070a0>&#34;ts&#34;</span>:<span style=color:#4070a0>&#34;2021-08-28T03:13:15.215-0400&#34;</span>,<span style=color:#4070a0>&#34;caller&#34;</span>:<span style=color:#4070a0>&#34;clientv3/retry_interceptor.go:61&#34;</span>,<span style=color:#4070a0>&#34;msg&#34;</span>:<span style=color:#4070a0>&#34;retrying of unary invoker failed&#34;</span>,<span style=color:#4070a0>&#34;target&#34;</span>:<span style=color:#4070a0>&#34;passthrough:///https://192.168.1.209:2379&#34;</span>,<span style=color:#4070a0>&#34;attempt&#34;</span>:0,<span style=color:#4070a0>&#34;error&#34;</span>:<span style=color:#4070a0>&#34;rpc error: code = DeadlineExceeded desc = context deadline exceeded&#34;</span><span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>upload-config<span style=color:#666>]</span> Storing the configuration used in ConfigMap <span style=color:#4070a0>&#34;kubeadm-config&#34;</span> in the <span style=color:#4070a0>&#34;kube-system&#34;</span> Namespace
</span></span><span style=display:flex><span><span style=color:#666>[</span>mark-control-plane<span style=color:#666>]</span> Marking the node sd-cluster-209 as control-plane by adding the label <span style=color:#4070a0>&#34;node-role.kubernetes.io/master=&#39;&#39;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>mark-control-plane<span style=color:#666>]</span> Marking the node sd-cluster-209 as control-plane by adding the taints <span style=color:#666>[</span>node-role.kubernetes.io/master:NoSchedule<span style=color:#666>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>This node has joined the cluster and a new control plane instance was created:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>* Certificate signing request was sent to apiserver and approval was received.
</span></span><span style=display:flex><span>* The Kubelet was informed of the new secure connection details.
</span></span><span style=display:flex><span>* Control plane <span style=color:#666>(</span>master<span style=color:#666>)</span> label and taint were applied to the new node.
</span></span><span style=display:flex><span>* The Kubernetes control plane instances scaled up.
</span></span><span style=display:flex><span>* A new etcd member was added to the local/stacked etcd cluster.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>To start administering your cluster from this node, you need to run the following as a regular user:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	mkdir -p <span style=color:#bb60d5>$HOME</span>/.kube
</span></span><span style=display:flex><span>	sudo cp -i /etc/kubernetes/admin.conf <span style=color:#bb60d5>$HOME</span>/.kube/config
</span></span><span style=display:flex><span>	sudo chown <span style=color:#007020;font-weight:700>$(</span>id -u<span style=color:#007020;font-weight:700>)</span>:<span style=color:#007020;font-weight:700>$(</span>id -g<span style=color:#007020;font-weight:700>)</span> <span style=color:#bb60d5>$HOME</span>/.kube/config
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Run <span style=color:#4070a0>&#39;kubectl get nodes&#39;</span> to see this node join the cluster.</span></span></code></pre></td></tr></table></div></div></div><h3 id=3-new-node-joins-the-cluster>3. New node joins the cluster</h3><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-2>2</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubeadm join 192.168.1.205:8443 --token abcdef.0123456789abcdef <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>    --discovery-token-ca-cert-hash sha256:7400f57a033f7527c80a4b015b54b4b6a88ccb2184ab9a6e39b709fb56e10486</span></span></code></pre></td></tr></table></div></div></div><h3 id=4-install-flannel-network-components>4. Install flannel network components</h3><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-16>16</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># wget http://raw.githubusercontent.com/coreos/flannel/master/Documentation/ kube-flannel.yml</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># sed -i &#39;s#quay.io/coreos/flannel:v0.14.0#registry.cn-shanghai.aliyuncs.com/gcr-k8s/flannel:v0.14.0#g&#39; kube-flannel. yml</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># kubectl apply -f kube-flannel.yml -n kube-system podsecuritypolicy.policy/psp.flannel.unprivileged created clusterrole.rbac.authorization.k8s.io/flannel created clusterrolebinding.rbac.authorization.k8s.io/flannel created serviceaccount/flannel created configmap/kube-flannel-cfg created daemonset .apps/kube-flannel-ds created # kubectl get pod -n kube-system |grep flannel kube-flannel-ds-gtdl8 1/1 Running 0 24s kube-flannel-ds-jtndz 1/1 Running 0 24s kube-flannel -ds-nd79b 1/1 Running 0 24s ``` ### 5. Install ingress ```shell docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v0.48.1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>wget https://github.com/kubernetes/ingress-nginx/releases/download/helm-chart-3.35.0/ingress- nginx-3.35.0.tgz
</span></span><span style=display:flex><span>tar zxvf helm-chart-3.35.0.tar.gz
</span></span><span style=display:flex><span><span style=color:#007020>cd</span> ingress-nginx
</span></span><span style=display:flex><span>vim values.yaml <span style=color:#60a0b0;font-style:italic>#Update the image to the domestic Alibaba image version above#helm install ingress-nginx --namespace ingress-nginx . -n ingress-nginx</span>
</span></span><span style=display:flex><span>NAME: ingress-nginx
</span></span><span style=display:flex><span>LAST DEPLOYED: Tue Aug <span style=color:#40a070>31</span> 17:02:28 <span style=color:#40a070>2021</span>
</span></span><span style=display:flex><span>NAMESPACE: ingress-nginx
</span></span><span style=display:flex><span>STATUS: deployed
</span></span><span style=display:flex><span>REVISION: <span style=color:#40a070>1</span>
</span></span><span style=display:flex><span>TEST SUITE: None NOTES: The ingress-nginx controller has been installed. Get the application URL by running these commands: <span style=color:#007020>export</span> <span style=color:#bb60d5>HTTP_NODE_PORT</span><span style=color:#666>=</span><span style=color:#007020;font-weight:700>$(</span>kubectl --namespace ingress-nginx get services -o <span style=color:#bb60d5>jsonpath</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;{.spec.ports[0].nodePort }&#34;</span> ingress-nginx-controller<span style=color:#007020;font-weight:700>)</span> <span style=color:#007020>export</span> <span style=color:#bb60d5>HTTPS_NODE_PORT</span><span style=color:#666>=</span><span style=color:#007020;font-weight:700>$(</span>kubectl --namespace ingress-nginx get services -o <span style=color:#bb60d5>jsonpath</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;{.spec.ports[1].nodePort}&#34;</span> ingress-nginx-controller<span style=color:#007020;font-weight:700>)</span> <span style=color:#007020>export</span> <span style=color:#bb60d5>NODE_IP</span><span style=color:#666>=</span><span style=color:#007020;font-weight:700>$(</span>kubectl --namespace ingress-nginx get nodes -o <span style=color:#bb60d5>jsonpath</span><span style=color:#666>=</span> <span style=color:#4070a0>&#34;{.items[0].status.addresses[1].address}&#34;</span><span style=color:#007020;font-weight:700>)</span> <span style=color:#007020>echo</span> <span style=color:#4070a0>&#34;Visit http://</span><span style=color:#bb60d5>$NODE_IP</span><span style=color:#4070a0>:</span><span style=color:#bb60d5>$HTTP_NODE_PORT</span><span style=color:#4070a0> to access your application via HTTP.&#34;</span> <span style=color:#007020>echo</span> <span style=color:#4070a0>&#34;Visit https://</span><span style=color:#bb60d5>$NODE_IP</span><span style=color:#4070a0>:</span>$<span style=color:#4070a0> HTTPS_NODE_PORT to access your application via HTTPS.&#34;</span> An example Ingress that makes use of the controller: apiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: annotations: kubernetes.io/ingress.class: nginx name: example namespace: foo spec: rules: - host: www.example.com http: paths: - backend: serviceName: exampleService servicePort: <span style=color:#40a070>80</span> path: / <span style=color:#60a0b0;font-style:italic># This section is only required if TLS is to be enabled for the Ingress tls: - hosts: - www.example.com secretName: example-tls If TLS is enabled for the Ingress, a Secret containing the certificate and key must also be provided: apiVersion: v1 kind: Secret metadata: name: example-tls namespace: foo data: tls.crt: &lt;base64 encoded cert&gt; tls.key: &lt;base64 encoded key&gt; type: kubernetes.io/tls ``` For the new Ingress, refer to the following settings: ```shell apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: my-nginx spec: rules: - host: &#34;my-nginx. test.com&#34; http: paths: - path: / backend:</span>
</span></span><span style=display:flex><span>serviceName: my-nginx
</span></span><span style=display:flex><span>servicePort: <span style=color:#40a070>8080</span></span></span></code></pre></td></tr></table></div></div></div><p>At this point, kubeadm has completed the deployment of the kubernetes high-availability cluster</p></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>wanzi</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2021-08-15</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><div class=post-reward><input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>Reward</label><div class=qr-code></div></div><footer class=post-footer><div class=post-tags><a href=/tags/kubeadm/>kubeadm</a>
<a href=/tags/k8s/>k8s</a>
<a href=/tags/haproxy/>haproxy</a>
<a href=/tags/keepalived/>keepalived</a></div><nav class=post-nav><a class=prev href=/post/kubernetes-gpushare-aliyun/><i class=iconfont><svg aria-hidden="true" class="lucide lucide-chevron-left hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="m15 18-6-6 6-6"/></svg></i><span class="prev-text nav-default">Alibaba Cloud Shared GPU Solution Test</span>
<span class="prev-text nav-mobile">Prev</span>
</a><a class=next href=/post/linux-dns-privatezone-bind9-dnsmasq/><span class="next-text nav-default">Alibaba Cloud PrivateZone+Bind9+Dnsmasq implements internal DNS</span>
<span class="prev-text nav-mobile">Next</span>
<i class=iconfont><svg aria-hidden="true" class="lucide lucide-chevron-right hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="m9 18 6-6-6-6"/></svg></i></a></nav></footer></article><div class=comment><script src=https://giscus.app/client.js data-repo=wzdushu/wzdushu.github.io data-repo-id=R_kgDONA8Shg data-category=General data-category-id=DIC_kwDONA8Shs4CjwIH data-mapping=pathname data-strict=1 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en crossorigin=anonymous async></script></div><div id=remark42></div></div><nav class=toc id=toc><div class=toc-title>Table of Contents</div><div class="toc-content custom-scrollbar"><nav id=TableOfContents><ul><li><a href=#1-basic-environment-settings>1. Basic environment settings</a><ul><li><a href=#1-install-docker-and-add-hosts>1. Install docker and add hosts</a></li><li><a href=#2-configure-hosts>2. Configure hosts</a></li><li><a href=#3-disable-the-firewall-and-set-selinux>3. Disable the firewall and set selinux</a></li><li><a href=#4-turn-off-swap>4. Turn off swap</a></li><li><a href=#5-install-kubeadm-kubelet-and-ipvsadm-for-all-nodes>5. Install kubeadm, kubelet, and ipvsadm for all nodes</a></li></ul></li><li><a href=#2-keepalived-cooperates-with-haproxy-to-achieve-high-availability-of-load-balancer>2. Keepalived cooperates with haproxy to achieve high availability of load balancer</a></li><li><a href=#3-kubeadm-initializes-the-k8s-cluster>3. kubeadm initializes the k8s cluster</a><ul><li><a href=#1-initialize-the-first-master>1. Initialize the first master</a></li><li><a href=#2-new-master-node-joins-the-cluster>2. New master node joins the cluster</a></li><li><a href=#3-new-node-joins-the-cluster>3. New node joins the cluster</a></li><li><a href=#4-install-flannel-network-components>4. Install flannel network components</a></li></ul></li></ul></nav></div></nav></div></main><footer id=footer class=footer><div class=social-icon-links><a href rel="me noopener" class=social-icon-link title=github target=_blank><svg aria-hidden="true" class="icon hi-svg-inline" fill="currentcolor" height="1em" viewBox="0 0 1024 1024" width="1em" xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04C242.005334 929.664 211.968 830.08 211.968 830.08 188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg></a><a href=/index.xml rel="noopener alternate" type=application/rss+xml class=social-icon-link title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span><span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span><span class=copyright-year>&copy;
2018 -
2024
<span class=heart><i class=iconfont><svg aria-hidden="true" class="lucide lucide-heart hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5.0 0016.5 3c-1.76.0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5.0 002 8.5c0 2.3 1.5 4.05 3 5.5l7 7z"/></svg></i></span><span class=author>丸子有记
</span></span><span><a href=https://www.foreverblog.cn/ target=_blank><img src=https://img.foreverblog.cn/logo_en_default.png alt style=width:auto;height:16px> </a>|<a href=https://beian.miit.gov.cn target=_blank>京ICP备2021004162号-1</a></span></div></footer><script type=text/javascript src=/js/main.e9535c2dd3b1d1ac40ed671376de7dddff0b15a6f9dcca3812b8e0dc2a0fca51.js integrity="sha256-6VNcLdOx0axA7WcTdt593f8LFab53Mo4Erjg3CoPylE=" crossorigin=anonymous></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script id=baidu_analytics>var _hmt=_hmt||[];(function(){if(window.location.hostname==="localhost")return;var t,e=document.createElement("script");e.async=!0,e.src="https://hm.baidu.com/hm.js?var _hmt = _hmt || [];(function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?9f80634ead11eb9ce00a6452d8891ed7"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script><script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script><script>var remark_config={host:"https://remark42.example.com",site_id:"remark",components:["embed","counter"]};!function(e,t){for(s=0;s<e.length;s++){var s,n=t.createElement("script"),o=".js",i=t.head||t.body;"noModule"in n?(n.type="module",o=".mjs"):n.async=!0,n.defer=!0,n.src=remark_config.host+"/web/"+e[s]+o,i.appendChild(n)}}(remark_config.components||["embed"],document)</script></body></html>